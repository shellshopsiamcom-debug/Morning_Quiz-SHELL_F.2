<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Morning Quiz - SHELL F.2</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Sarabun', sans-serif; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .hidden { display: none !important; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen pb-10">

    <!-- CONFIGURATION -->
    <script>
        // --- นำ Web App URL ที่ได้จากการ Deploy Google Apps Script มาใส่ตรงนี้ ---
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwJxaPVPAID31W_i3HMZ_WRfq-j3AqoFKdPDksS5ftp5cR7nWyLlD66G871zsoForzV/exec"; 
    </script>

    <!-- HEADER -->
    <header class="bg-yellow-400 p-4 shadow-md text-slate-900 sticky top-0 z-10">
        <div class="container mx-auto flex items-center justify-between">
            <h1 class="font-bold text-xl flex items-center gap-2">
                <i data-lucide="activity" class="text-red-600 w-6 h-6"></i>
                Morning Quiz <span class="text-xs bg-red-600 text-white px-2 py-0.5 rounded-full">SHELL F.2</span>
            </h1>
            <div id="header-user-info" class="text-xs font-semibold hidden sm:block"></div>
        </div>
    </header>

    <!-- SECTION 1: LOGIN -->
    <section id="step-login" class="container mx-auto p-4 flex justify-center items-center mt-10 fade-in">
        <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-md border-t-4 border-yellow-400">
            <h2 class="text-2xl font-bold mb-6 text-center text-slate-700">ลงทะเบียนเข้าสอบ</h2>
            <form id="login-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-slate-600 mb-1">ชื่อ-นามสกุล</label>
                    <div class="relative">
                        <i data-lucide="user" class="absolute left-3 top-3 w-5 h-5 text-slate-400"></i>
                        <input type="text" id="input-name" required
                            class="w-full pl-10 p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-yellow-400 outline-none"
                            placeholder="กรอกชื่อจริง">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-600 mb-1">รหัสพนักงาน</label>
                    <div class="relative">
                        <i data-lucide="clipboard-list" class="absolute left-3 top-3 w-5 h-5 text-slate-400"></i>
                        <input type="text" id="input-empid" required
                            class="w-full pl-10 p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-yellow-400 outline-none"
                            placeholder="เช่น 12345">
                    </div>
                </div>
                <button type="submit" class="w-full bg-red-600 text-white p-3 rounded-lg font-bold hover:bg-red-700 transition shadow-md">
                    เข้าสู่ระบบ
                </button>
            </form>
        </div>
    </section>

    <!-- SECTION 2: SELECT -->
    <section id="step-select" class="container mx-auto p-4 mt-6 hidden fade-in">
        <div class="bg-white p-6 rounded-xl shadow-lg max-w-lg mx-auto border-t-4 border-red-500">
            <div class="flex justify-between items-center mb-6 border-b pb-4">
                <h2 class="text-xl font-bold text-slate-700">เลือกพื้นที่ปฏิบัติงาน</h2>
                <div class="text-right text-xs text-slate-500">
                    <p>ผู้สอบ: <span id="display-name" class="font-semibold text-slate-700"></span></p>
                </div>
            </div>

            <div class="space-y-6">
                <!-- Line -->
                <div>
                    <label class="block text-sm font-medium text-slate-600 mb-2 flex items-center gap-2">
                        <i data-lucide="layers" class="w-4 h-4"></i> เลือกไลน์การผลิต (Line)
                    </label>
                    <div id="loading-lines" class="text-sm text-slate-400 hidden">กำลังโหลดข้อมูล...</div>
                    <select id="select-line" class="w-full p-3 border border-slate-300 rounded-lg bg-white focus:ring-2 focus:ring-yellow-400 outline-none">
                        <option value="">-- กรุณาเลือกไลน์ --</option>
                    </select>
                </div>

                <!-- Process -->
                <div>
                    <label class="block text-sm font-medium text-slate-600 mb-2 flex items-center gap-2">
                        <i data-lucide="refresh-cw" class="w-4 h-4"></i> เลือกกระบวนการ (Process)
                    </label>
                    <select id="select-process" disabled class="w-full p-3 border border-slate-300 rounded-lg bg-gray-100 focus:ring-2 focus:ring-yellow-400 outline-none">
                        <option value="">-- กรุณาเลือกกระบวนการ --</option>
                    </select>
                </div>

                <div id="select-error" class="hidden flex items-start gap-2 text-red-600 text-sm bg-red-50 p-3 rounded border border-red-200">
                    <i data-lucide="server-crash" class="w-5 h-5 shrink-0"></i>
                    <span id="select-error-msg"></span>
                </div>

                <button id="btn-start-quiz" disabled
                    class="w-full p-3 rounded-lg font-bold text-white transition shadow-md flex justify-center items-center gap-2 bg-gray-400 cursor-not-allowed">
                    <span id="btn-start-text">เริ่มทำแบบทดสอบ</span>
                    <i data-lucide="send" class="w-5 h-5"></i>
                </button>
            </div>
        </div>
    </section>

    <!-- SECTION 3: QUIZ -->
    <section id="step-quiz" class="container mx-auto p-4 max-w-2xl hidden fade-in">
        <div class="bg-white rounded-xl shadow-lg p-6 mb-4 border-l-4 border-yellow-400">
            <h2 class="text-lg font-bold text-slate-700">แบบทดสอบ: <span id="quiz-title"></span></h2>
            <p class="text-sm text-slate-500 mt-1">เกณฑ์ผ่าน: ถูกทุกข้อ (100%)</p>
        </div>

        <div id="questions-container" class="space-y-6">
            <!-- Questions will be injected here -->
        </div>

        <div class="mt-8">
            <button id="btn-submit-quiz" class="w-full bg-red-600 text-white p-4 rounded-xl font-bold text-lg hover:bg-red-700 transition shadow-lg flex justify-center items-center gap-2">
                ส่งคำตอบ
            </button>
        </div>
    </section>

    <!-- SECTION 4: RESULT -->
    <section id="step-result" class="container mx-auto p-4 flex justify-center items-center mt-10 hidden fade-in">
        <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-md text-center">
            
            <!-- Pass View -->
            <div id="result-pass" class="hidden">
                <div class="mx-auto bg-green-100 w-20 h-20 rounded-full flex items-center justify-center mb-4">
                    <i data-lucide="check-circle" class="w-12 h-12 text-green-600"></i>
                </div>
                <h2 class="text-2xl font-bold text-green-700 mb-2">ผ่านการทดสอบ!</h2>
                <p class="text-slate-600 mb-6">คุณทำได้ <span class="score-display"></span> คะแนน</p>
                <div class="bg-slate-50 p-4 rounded-lg mb-6 text-sm text-left border border-slate-200">
                    <p><span class="font-semibold">ชื่อ:</span> <span class="user-name-display"></span></p>
                    <p><span class="font-semibold">Line:</span> <span class="line-display"></span></p>
                    <p><span class="font-semibold">Process:</span> <span class="process-display"></span></p>
                    <p class="text-green-600 font-bold mt-2 flex items-center gap-1">
                        <i data-lucide="check-circle" class="w-4 h-4"></i> บันทึกผลสำเร็จ
                    </p>
                </div>
                <button onclick="location.reload()" class="w-full bg-slate-800 text-white p-3 rounded-lg font-bold hover:bg-slate-900 transition">
                    เสร็จสิ้น / ปิดหน้าต่าง
                </button>
            </div>

            <!-- Fail View -->
            <div id="result-fail" class="hidden">
                <div class="mx-auto bg-red-100 w-20 h-20 rounded-full flex items-center justify-center mb-4">
                    <i data-lucide="x-circle" class="w-12 h-12 text-red-600"></i>
                </div>
                <h2 class="text-2xl font-bold text-red-700 mb-2">ไม่ผ่านการทดสอบ</h2>
                <p class="text-slate-600 mb-6">คุณทำได้ <span class="score-display"></span> คะแนน</p>
                <div class="flex items-start justify-start gap-2 text-yellow-800 bg-yellow-50 p-4 rounded-lg mb-6 border border-yellow-200 text-left text-sm">
                    <i data-lucide="alert-triangle" class="w-5 h-5 shrink-0"></i>
                    <span>
                        <strong>เงื่อนไข:</strong> ต้องตอบถูกทุกข้อ (100%) เท่านั้นจึงจะผ่านเกณฑ์ <br/>
                        *ระบบไม่ได้บันทึกผลการสอบครั้งนี้
                    </span>
                </div>
                <button id="btn-retry" class="w-full bg-red-600 text-white p-3 rounded-lg font-bold hover:bg-red-700 transition shadow-md">
                    ทำแบบทดสอบใหม่
                </button>
            </div>

        </div>
    </section>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        // State
        let state = {
            user: { name: '', empId: '' },
            selection: { line: '', process: '' },
            questions: [],
            answers: {},
            lines: [],
            processes: []
        };

        // Fallback Data
        const FALLBACK_DATA = {
            lines: ["Line A (Demo)", "Line B (Demo)", "Line C (Demo)"],
            processes: Array.from({ length: 17 }, (_, i) => `Process ${i + 1} (Demo)`)
        };

        // Init Lucide Icons
        lucide.createIcons();

        // --- DOM Elements ---
        const sections = {
            login: document.getElementById('step-login'),
            select: document.getElementById('step-select'),
            quiz: document.getElementById('step-quiz'),
            result: document.getElementById('step-result')
        };

        // --- Navigation Functions ---
        function showSection(sectionName) {
            Object.values(sections).forEach(el => el.classList.add('hidden'));
            sections[sectionName].classList.remove('hidden');
            lucide.createIcons(); // Re-render icons for the new section
        }

        // --- Step 1: Login ---
        document.getElementById('login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const name = document.getElementById('input-name').value.trim();
            const empId = document.getElementById('input-empid').value.trim();

            if (name && empId) {
                state.user = { name, empId };
                document.getElementById('header-user-info').innerText = `${name} (${empId})`;
                document.getElementById('display-name').innerText = name;
                
                // Load dropdowns next
                showSection('select');
                fetchDropdowns();
            }
        });

        // --- Step 2: Select ---
        async function fetchDropdowns() {
            const lineSelect = document.getElementById('select-line');
            const loadingText = document.getElementById('loading-lines');
            const errorDiv = document.getElementById('select-error');
            const errorMsg = document.getElementById('select-error-msg');
            
            loadingText.classList.remove('hidden');
            errorDiv.classList.add('hidden'); // ซ่อน error เก่า (ถ้ามี)
            lineSelect.disabled = true;

            try {
                let data = { lines: [], processes: [] };

                if (GOOGLE_SCRIPT_URL) {
                    const response = await fetch(`${GOOGLE_SCRIPT_URL}?action=getDropdowns`);
                    // ** IMPROVED ERROR HANDLING **
                    // อ่านเป็น Text ก่อนเพื่อตรวจสอบว่าใช่ JSON หรือไม่
                    const responseText = await response.text();
                    
                    try {
                        data = JSON.parse(responseText);
                    } catch (parseError) {
                        console.error("API Error: Response is not JSON", responseText);
                        // ถ้า parse ไม่ผ่าน แสดงว่า Server ส่งข้อความ error หรือ html กลับมา
                        // โดยเฉพาะ "Service is running" แปลว่าลืม Deploy ใหม่
                        throw new Error(`Google Script Error: ${responseText} (กรุณา Deploy New Version)`);
                    }
                } else {
                    // Demo mode delay
                    await new Promise(r => setTimeout(r, 500));
                }

                // Use fallback if empty
                if (!data.lines || data.lines.length === 0) {
                    // ถ้าต่อ API ได้แต่ไม่มีข้อมูล ให้ลองใช้ Fallback หรือแจ้งเตือน
                    if (GOOGLE_SCRIPT_URL) {
                        console.warn("API returned empty data, using fallback.");
                    }
                    state.lines = FALLBACK_DATA.lines;
                    state.processes = FALLBACK_DATA.processes;
                } else {
                    state.lines = data.lines;
                    state.processes = data.processes;
                }

                // Populate UI
                populateSelect('select-line', state.lines);
                populateSelect('select-process', state.processes);

            } catch (err) {
                console.error(err);
                // แสดง Error บนหน้าจอ
                errorDiv.classList.remove('hidden');
                errorMsg.innerText = err.message;
                
                // ยังคงใช้ Fallback data เพื่อให้แอปไม่ค้าง
                state.lines = FALLBACK_DATA.lines;
                state.processes = FALLBACK_DATA.processes;
                populateSelect('select-line', state.lines);
                populateSelect('select-process', state.processes);
            } finally {
                loadingText.classList.add('hidden');
                lineSelect.disabled = false;
            }
        }

        function populateSelect(id, items) {
            const select = document.getElementById(id);
            // keep first option
            select.innerHTML = select.options[0].outerHTML;
            items.forEach(item => {
                const opt = document.createElement('option');
                opt.value = item;
                opt.innerText = item;
                select.appendChild(opt);
            });
        }

        // Handle Selection Change
        document.getElementById('select-line').addEventListener('change', (e) => {
            state.selection.line = e.target.value;
            const processSelect = document.getElementById('select-process');
            processSelect.disabled = !e.target.value;
            processSelect.classList.toggle('bg-gray-100', !e.target.value);
            processSelect.classList.toggle('bg-white', !!e.target.value);
            checkStartButton();
        });

        document.getElementById('select-process').addEventListener('change', (e) => {
            state.selection.process = e.target.value;
            checkStartButton();
        });

        function checkStartButton() {
            const btn = document.getElementById('btn-start-quiz');
            const ready = state.selection.line && state.selection.process;
            btn.disabled = !ready;
            btn.classList.toggle('bg-gray-400', !ready);
            btn.classList.toggle('cursor-not-allowed', !ready);
            btn.classList.toggle('bg-yellow-500', ready);
            btn.classList.toggle('hover:bg-yellow-600', ready);
            btn.classList.toggle('text-slate-900', ready);
        }

        document.getElementById('btn-start-quiz').addEventListener('click', fetchQuestions);

        // --- Step 3: Quiz ---
        async function fetchQuestions() {
            const btn = document.getElementById('btn-start-quiz');
            const btnText = document.getElementById('btn-start-text');
            const errorDiv = document.getElementById('select-error');
            const errorMsg = document.getElementById('select-error-msg');
            
            btn.disabled = true;
            btnText.innerText = "กำลังโหลด...";
            errorDiv.classList.add('hidden');

            try {
                let qData = [];
                if (GOOGLE_SCRIPT_URL) {
                    const url = `${GOOGLE_SCRIPT_URL}?action=getQuestions&line=${encodeURIComponent(state.selection.line)}&process=${encodeURIComponent(state.selection.process)}`;
                    const res = await fetch(url);
                    
                    // ** IMPROVED ERROR HANDLING HERE TOO **
                    const text = await res.text();
                    let data;
                    try {
                        data = JSON.parse(text);
                    } catch (e) {
                         throw new Error(`Google Script Error: ${text}`);
                    }

                    if (data.error) throw new Error(data.error);
                    qData = data.questions;
                } else {
                    await new Promise(r => setTimeout(r, 1000));
                    // Mock Logic
                    qData = [
                        ...Array.from({ length: 2 }, (_, i) => ({ id: `p1_${i}`, part: 1, text: `คำถามส่วนกลาง ข้อที่ ${i+1}`, options: ["ถูกต้อง", "ไม่ถูกต้อง"], correct: "ถูกต้อง" })),
                        ...Array.from({ length: 2 }, (_, i) => ({ id: `p2_${i}`, part: 2, text: `คำถาม ${state.selection.process} ข้อที่ ${i+1}`, options: ["A", "B", "C"], correct: "A" })),
                        { id: `p3_0`, part: 3, text: `Critical Point ของ ${state.selection.process}?`, options: ["High", "Medium", "Low"], correct: "High" }
                    ];
                }

                if (!qData || qData.length === 0) throw new Error("ไม่พบข้อมูลข้อสอบ");

                state.questions = qData;
                state.answers = {};
                renderQuiz();
                showSection('quiz');

            } catch (err) {
                errorDiv.classList.remove('hidden');
                errorMsg.innerText = err.message;
            } finally {
                btn.disabled = false;
                btnText.innerText = "เริ่มทำแบบทดสอบ";
            }
        }

        function renderQuiz() {
            document.getElementById('quiz-title').innerText = `${state.selection.line} - ${state.selection.process}`;
            const container = document.getElementById('questions-container');
            container.innerHTML = '';

            state.questions.forEach((q, idx) => {
                const partLabel = q.part === 1 ? 'ส่วนที่ 1 (ทั่วไป)' : q.part === 2 ? 'ส่วนที่ 2 (Process)' : 'ส่วนที่ 3 (Critical)';
                const badgeColor = q.part === 1 ? 'bg-blue-100 text-blue-700' : q.part === 2 ? 'bg-purple-100 text-purple-700' : 'bg-red-100 text-red-700';

                const card = document.createElement('div');
                card.className = 'bg-white p-6 rounded-xl shadow-sm border border-slate-200';
                
                let optionsHtml = '';
                q.options.forEach(opt => {
                    optionsHtml += `
                        <label class="flex items-center p-3 rounded-lg border cursor-pointer hover:bg-slate-50 border-slate-200 transition select-none option-label" data-qid="${q.id}">
                            <input type="radio" name="${q.id}" value="${opt}" onchange="handleAnswer('${q.id}', '${opt}')" class="h-5 w-5 text-yellow-500 focus:ring-yellow-400 border-gray-300 accent-yellow-500">
                            <span class="ml-3 text-slate-700">${opt}</span>
                        </label>
                    `;
                });

                card.innerHTML = `
                    <div class="mb-4">
                        <span class="inline-block text-xs px-2 py-1 rounded mb-2 font-semibold ${badgeColor}">${partLabel}</span>
                        <h3 class="font-semibold text-lg text-slate-800">${idx + 1}. ${q.text}</h3>
                    </div>
                    <div class="space-y-2" id="options-${q.id}">
                        ${optionsHtml}
                    </div>
                `;
                container.appendChild(card);
            });
        }

        window.handleAnswer = (qId, val) => {
            state.answers[qId] = val;
            // Highlight styling
            const container = document.getElementById(`options-${qId}`);
            const labels = container.querySelectorAll('label');
            labels.forEach(lbl => {
                const radio = lbl.querySelector('input');
                if (radio.checked) {
                    lbl.classList.add('bg-yellow-50', 'border-yellow-400', 'shadow-sm');
                    lbl.classList.remove('border-slate-200');
                } else {
                    lbl.classList.remove('bg-yellow-50', 'border-yellow-400', 'shadow-sm');
                    lbl.classList.add('border-slate-200');
                }
            });
        };

        document.getElementById('btn-submit-quiz').addEventListener('click', async () => {
            if (Object.keys(state.answers).length < state.questions.length) {
                alert("กรุณาทำข้อสอบให้ครบทุกข้อ");
                return;
            }

            const btn = document.getElementById('btn-submit-quiz');
            btn.innerText = "กำลังประมวลผล...";
            btn.disabled = true;

            // Check Answers
            let score = 0;
            let isAllCorrect = true;
            state.questions.forEach(q => {
                if (state.answers[q.id] === q.correct) score++;
                else isAllCorrect = false;
            });

            const passed = isAllCorrect; // ต้องถูก 100%

            if (passed && GOOGLE_SCRIPT_URL) {
                try {
                    await fetch(GOOGLE_SCRIPT_URL, {
                        method: 'POST',
                        body: JSON.stringify({
                            action: 'submit',
                            user: state.user,
                            selection: state.selection,
                            score: score,
                            total: state.questions.length,
                            status: 'Passed'
                        })
                    });
                } catch (e) {
                    console.error("Save failed", e);
                }
            }

            // Show Result
            renderResult(passed, score);
            showSection('result');
            btn.innerText = "ส่งคำตอบ";
            btn.disabled = false;
        });

        // --- Step 4: Result ---
        function renderResult(passed, score) {
            document.querySelectorAll('.score-display').forEach(el => el.innerText = `${score}/${state.questions.length}`);
            document.querySelectorAll('.user-name-display').forEach(el => el.innerText = state.user.name);
            document.querySelectorAll('.line-display').forEach(el => el.innerText = state.selection.line);
            document.querySelectorAll('.process-display').forEach(el => el.innerText = state.selection.process);

            if (passed) {
                document.getElementById('result-pass').classList.remove('hidden');
                document.getElementById('result-fail').classList.add('hidden');
            } else {
                document.getElementById('result-pass').classList.add('hidden');
                document.getElementById('result-fail').classList.remove('hidden');
            }
        }

        document.getElementById('btn-retry').addEventListener('click', () => {
            state.answers = {};
            // กลับไปหน้า select เพื่อเริ่มใหม่
            showSection('select');
        });

    </script>
</body>
</html>


