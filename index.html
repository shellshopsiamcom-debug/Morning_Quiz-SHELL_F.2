import React, { useState, useEffect } from 'react';
import { User, ClipboardList, CheckCircle, XCircle, AlertTriangle, Send, RefreshCw, Layers, Activity, ServerCrash } from 'lucide-react';

// --- CONFIGURATION ---
// นำ Web App URL ที่ได้จากการ Deploy Google Apps Script มาใส่ตรงนี้
const GOOGLE_SCRIPT_URL = ""; 

export default function App() {
  const [step, setStep] = useState('login'); // login, select, quiz, result
  const [user, setUser] = useState({ name: '', empId: '' });
  const [selection, setSelection] = useState({ line: '', process: '' });
  
  // Data States
  const [dropdownData, setDropdownData] = useState({ lines: [], processes: [] });
  const [questions, setQuestions] = useState([]);
  const [answers, setAnswers] = useState({});
  
  // UI States
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState('');
  const [result, setResult] = useState(null);

  // --- MOCK DATA (ใช้กรณีไม่ได้ใส่ URL หรือดึงข้อมูลไม่ได้) ---
  const FALLBACK_DATA = {
    lines: ["Line A (Demo)", "Line B (Demo)", "Line C (Demo)"],
    processes: Array.from({ length: 17 }, (_, i) => `Process ${i + 1} (Demo)`),
    // Mock Questions logic handled inside fetchQuestions fallback
  };

  // --- EFFECTS ---

  // ดึงข้อมูล Master Dropdown เมื่อเข้าสู่หน้า Select
  useEffect(() => {
    if (step === 'select') {
      fetchDropdowns();
    }
  }, [step]);

  // --- API HANDLERS ---

  const fetchDropdowns = async () => {
    setLoading(true);
    try {
      if (GOOGLE_SCRIPT_URL) {
        const response = await fetch(`${GOOGLE_SCRIPT_URL}?action=getDropdowns`);
        const data = await response.json();
        
        // ถ้า Sheet Master ว่างเปล่า หรือยังไม่ได้ตั้งค่า ให้ใช้ค่าว่างหรือ fallback
        if (data.lines && data.lines.length > 0) {
          setDropdownData({ lines: data.lines, processes: data.processes });
        } else {
          // Fallback if empty array returned
          setDropdownData({ lines: FALLBACK_DATA.lines, processes: FALLBACK_DATA.processes });
        }
      } else {
        // Fallback for Demo Mode
        await new Promise(r => setTimeout(r, 500)); // Simulate delay
        setDropdownData({ lines: FALLBACK_DATA.lines, processes: FALLBACK_DATA.processes });
      }
    } catch (err) {
      console.error("Failed to fetch dropdowns:", err);
      // Fallback on error
      setDropdownData({ lines: FALLBACK_DATA.lines, processes: FALLBACK_DATA.processes });
    } finally {
      setLoading(false);
    }
  };

  const fetchQuestions = async () => {
    setLoading(true);
    setError('');
    setQuestions([]);
    
    try {
      let qData = [];

      if (GOOGLE_SCRIPT_URL) {
        // Mode: Connected to Google Sheet
        const response = await fetch(`${GOOGLE_SCRIPT_URL}?action=getQuestions&line=${encodeURIComponent(selection.line)}&process=${encodeURIComponent(selection.process)}`);
        const data = await response.json();
        
        if (data.error) throw new Error(data.error);
        qData = data.questions;

      } else {
        // Mode: Mock Data (Logic จำลองการสุ่ม)
        await new Promise(r => setTimeout(r, 1000));
        
        const mockPart1 = Array.from({ length: 2 }, (_, i) => ({
          id: `p1_${i}`, part: 1, text: `คำถามส่วนกลาง ข้อที่ ${i + 1} (ปลอดภัยหรือไม่)`, 
          options: ["ถูกต้อง", "ไม่ถูกต้อง"], correct: "ถูกต้อง"
        }));
        
        const mockPart2 = Array.from({ length: 2 }, (_, i) => ({
          id: `p2_${i}`, part: 2, text: `คำถามเฉพาะ ${selection.process} ข้อที่ ${i + 1}`, 
          options: ["A", "B", "C"], correct: "A"
        }));
        
        const mockPart3 = [{
          id: `p3_0`, part: 3, text: `จุด Critical Point ของ ${selection.process} คือ?`, 
          options: ["High", "Medium", "Low"], correct: "High"
        }];
        
        qData = [...mockPart1, ...mockPart2, ...mockPart3];
      }

      if (!qData || qData.length === 0) {
        throw new Error("ไม่พบข้อมูลข้อสอบ กรุณาตรวจสอบ Sheet Database");
      }

      setQuestions(qData);
      setStep('quiz');
    } catch (err) {
      setError('เกิดข้อผิดพลาด: ' + err.message);
    } finally {
      setLoading(false);
    }
  };

  const submitAnswers = async (score, total, passed) => {
    if (GOOGLE_SCRIPT_URL && passed) {
      try {
        await fetch(GOOGLE_SCRIPT_URL, {
          method: 'POST',
          body: JSON.stringify({
            action: 'submit',
            user: user,
            selection: selection,
            score: score,
            total: total,
            status: passed ? 'Passed' : 'Failed'
          })
        });
      } catch (e) {
        console.error("Save error", e);
        // User still sees result screen even if save fails (optional: show error)
      }
    }
  };

  // --- INTERACTION HANDLERS ---

  const handleLogin = (e) => {
    e.preventDefault();
    if (user.name && user.empId) setStep('select');
  };

  const handleAnswer = (qId, value) => {
    setAnswers(prev => ({ ...prev, [qId]: value }));
  };

  const checkAnswers = async () => {
    if (Object.keys(answers).length < questions.length) {
      alert("กรุณาทำข้อสอบให้ครบทุกข้อ");
      return;
    }

    setLoading(true);
    
    // ตรวจคำตอบ Client-side
    let score = 0;
    let isAllCorrect = true;

    questions.forEach(q => {
      if (answers[q.id] === q.correct) {
        score++;
      } else {
        isAllCorrect = false;
      }
    });

    const passed = isAllCorrect; // โจทย์กำหนด: ต้องถูกทุกข้อ

    // ถ้าผ่าน ให้ส่งข้อมูลไปบันทึก
    if (passed) {
      await submitAnswers(score, questions.length, passed);
    }
    
    setResult({ passed, score });
    setStep('result');
    setLoading(false);
  };

  const resetQuiz = () => {
    setAnswers({});
    setResult(null);
    setStep('select'); // กลับไปหน้าเลือกไลน์ใหม่ หรือจะไปหน้า login ก็ได้แล้วแต่ design
  };

  // --- RENDER HELPERS ---

  const Header = () => (
    <div className="bg-yellow-400 p-4 shadow-md text-slate-900 sticky top-0 z-10">
      <div className="container mx-auto flex items-center justify-between">
        <h1 className="font-bold text-xl flex items-center gap-2">
          <Activity className="h-6 w-6 text-red-600" />
          Morning Quiz <span className="text-xs bg-red-600 text-white px-2 py-0.5 rounded-full">SHELL F.2</span>
        </h1>
        {user.name && <div className="text-xs font-semibold hidden sm:block">{user.name} ({user.empId})</div>}
      </div>
    </div>
  );

  // --- VIEWS ---

  // 1. LOGIN
  if (step === 'login') {
    return (
      <div className="min-h-screen bg-slate-50 font-sans">
        <Header />
        <div className="container mx-auto p-4 flex justify-center items-center mt-10">
          <div className="bg-white p-8 rounded-xl shadow-lg w-full max-w-md border-t-4 border-yellow-400">
            <h2 className="text-2xl font-bold mb-6 text-center text-slate-700">ลงทะเบียนเข้าสอบ</h2>
            <form onSubmit={handleLogin} className="space-y-4">
              <div>
                <label className="block text-sm font-medium text-slate-600 mb-1">ชื่อ-นามสกุล</label>
                <div className="relative">
                  <User className="absolute left-3 top-3 h-5 w-5 text-slate-400" />
                  <input 
                    type="text" 
                    required
                    className="w-full pl-10 p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-yellow-400 outline-none"
                    placeholder="กรอกชื่อจริง"
                    value={user.name}
                    onChange={e => setUser({...user, name: e.target.value})}
                  />
                </div>
              </div>
              <div>
                <label className="block text-sm font-medium text-slate-600 mb-1">รหัสพนักงาน</label>
                <div className="relative">
                  <ClipboardList className="absolute left-3 top-3 h-5 w-5 text-slate-400" />
                  <input 
                    type="text" 
                    required
                    className="w-full pl-10 p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-yellow-400 outline-none"
                    placeholder="เช่น 12345"
                    value={user.empId}
                    onChange={e => setUser({...user, empId: e.target.value})}
                  />
                </div>
              </div>
              <button type="submit" className="w-full bg-red-600 text-white p-3 rounded-lg font-bold hover:bg-red-700 transition shadow-md">
                เข้าสู่ระบบ
              </button>
            </form>
          </div>
        </div>
      </div>
    );
  }

  // 2. SELECTION
  if (step === 'select') {
    return (
      <div className="min-h-screen bg-slate-50 font-sans">
        <Header />
        <div className="container mx-auto p-4 mt-6">
          <div className="bg-white p-6 rounded-xl shadow-lg max-w-lg mx-auto border-t-4 border-red-500">
            <div className="flex justify-between items-center mb-6 border-b pb-4">
              <h2 className="text-xl font-bold text-slate-700">เลือกพื้นที่ปฏิบัติงาน</h2>
              <div className="text-right text-xs text-slate-500">
                <p>ผู้สอบ: <span className="font-semibold text-slate-700">{user.name}</span></p>
              </div>
            </div>

            <div className="space-y-6">
              {/* LINE SELECTION */}
              <div>
                <label className="block text-sm font-medium text-slate-600 mb-2 flex items-center gap-2">
                  <Layers className="h-4 w-4" /> เลือกไลน์การผลิต (Line)
                </label>
                {loading && dropdownData.lines.length === 0 ? (
                   <div className="p-3 bg-slate-100 text-slate-400 rounded-lg text-sm">กำลังโหลดข้อมูล...</div>
                ) : (
                  <select 
                    className="w-full p-3 border border-slate-300 rounded-lg bg-white focus:ring-2 focus:ring-yellow-400 outline-none"
                    value={selection.line}
                    onChange={e => setSelection({...selection, line: e.target.value})}
                  >
                    <option value="">-- กรุณาเลือกไลน์ --</option>
                    {dropdownData.lines.map((l, idx) => <option key={idx} value={l}>{l}</option>)}
                  </select>
                )}
              </div>

              {/* PROCESS SELECTION */}
              <div>
                <label className="block text-sm font-medium text-slate-600 mb-2 flex items-center gap-2">
                  <RefreshCw className="h-4 w-4" /> เลือกกระบวนการ (Process)
                </label>
                {loading && dropdownData.processes.length === 0 ? (
                   <div className="p-3 bg-slate-100 text-slate-400 rounded-lg text-sm">กำลังโหลดข้อมูล...</div>
                ) : (
                  <select 
                    className="w-full p-3 border border-slate-300 rounded-lg bg-white focus:ring-2 focus:ring-yellow-400 outline-none"
                    value={selection.process}
                    onChange={e => setSelection({...selection, process: e.target.value})}
                    disabled={!selection.line}
                  >
                    <option value="">-- กรุณาเลือกกระบวนการ --</option>
                    {dropdownData.processes.map((p, idx) => <option key={idx} value={p}>{p}</option>)}
                  </select>
                )}
              </div>

              {error && (
                <div className="flex items-start gap-2 text-red-600 text-sm bg-red-50 p-3 rounded border border-red-200">
                  <ServerCrash className="h-5 w-5 shrink-0" />
                  <span>{error}</span>
                </div>
              )}

              <button 
                onClick={fetchQuestions}
                disabled={!selection.line || !selection.process || loading}
                className={`w-full p-3 rounded-lg font-bold text-white transition shadow-md flex justify-center items-center gap-2
                  ${(!selection.line || !selection.process || loading) ? 'bg-gray-400 cursor-not-allowed' : 'bg-yellow-500 hover:bg-yellow-600 text-slate-900'}`}
              >
                {loading ? <span className="animate-spin">⌛</span> : <Send className="h-5 w-5" />}
                เริ่มทำแบบทดสอบ
              </button>
            </div>
          </div>
        </div>
      </div>
    );
  }

  // 3. QUIZ
  if (step === 'quiz') {
    return (
      <div className="min-h-screen bg-slate-50 font-sans pb-10">
        <Header />
        <div className="container mx-auto p-4 max-w-2xl">
          <div className="bg-white rounded-xl shadow-lg p-6 mb-4 border-l-4 border-yellow-400">
            <h2 className="text-lg font-bold text-slate-700">แบบทดสอบ: {selection.line} - {selection.process}</h2>
            <p className="text-sm text-slate-500 mt-1">จำนวน {questions.length} ข้อ | เกณฑ์ผ่าน: ถูกทุกข้อ (100%)</p>
          </div>

          <div className="space-y-6">
            {questions.map((q, index) => (
              <div key={q.id} className="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                <div className="mb-4">
                  <span className={`inline-block text-xs px-2 py-1 rounded mb-2 font-semibold
                    ${q.part === 1 ? 'bg-blue-100 text-blue-700' : q.part === 2 ? 'bg-purple-100 text-purple-700' : 'bg-red-100 text-red-700'}`}>
                    {q.part === 1 ? 'ส่วนที่ 1 (ทั่วไป)' : q.part === 2 ? 'ส่วนที่ 2 (Process)' : 'ส่วนที่ 3 (Critical)'}
                  </span>
                  <h3 className="font-semibold text-lg text-slate-800">{index + 1}. {q.text}</h3>
                </div>
                
                <div className="space-y-2">
                  {q.options.map((opt, i) => (
                    <label 
                      key={i} 
                      className={`flex items-center p-3 rounded-lg border cursor-pointer transition select-none
                        ${answers[q.id] === opt ? 'bg-yellow-50 border-yellow-400 shadow-sm' : 'border-slate-200 hover:bg-slate-50'}`}
                    >
                      <input 
                        type="radio" 
                        name={q.id} 
                        value={opt} 
                        checked={answers[q.id] === opt}
                        onChange={() => handleAnswer(q.id, opt)}
                        className="h-5 w-5 text-yellow-500 focus:ring-yellow-400 border-gray-300 accent-yellow-500"
                      />
                      <span className="ml-3 text-slate-700">{opt}</span>
                    </label>
                  ))}
                </div>
              </div>
            ))}
          </div>

          <div className="mt-8">
            <button 
              onClick={checkAnswers}
              disabled={loading}
              className="w-full bg-red-600 text-white p-4 rounded-xl font-bold text-lg hover:bg-red-700 transition shadow-lg flex justify-center items-center gap-2"
            >
              {loading ? "กำลังประมวลผล..." : "ส่งคำตอบ"}
            </button>
          </div>
        </div>
      </div>
    );
  }

  // 4. RESULT
  if (step === 'result') {
    return (
      <div className="min-h-screen bg-slate-50 font-sans">
        <Header />
        <div className="container mx-auto p-4 flex justify-center items-center mt-10">
          <div className="bg-white p-8 rounded-xl shadow-lg w-full max-w-md text-center">
            {result.passed ? (
              <div className="animate-in fade-in zoom-in duration-300">
                <div className="mx-auto bg-green-100 w-20 h-20 rounded-full flex items-center justify-center mb-4">
                  <CheckCircle className="h-12 w-12 text-green-600" />
                </div>
                <h2 className="text-2xl font-bold text-green-700 mb-2">ผ่านการทดสอบ!</h2>
                <p className="text-slate-600 mb-6">คุณทำได้ {result.score}/{questions.length} คะแนน</p>
                
                <div className="bg-slate-50 p-4 rounded-lg mb-6 text-sm text-left border border-slate-200">
                  <p><span className="font-semibold">ชื่อ:</span> {user.name}</p>
                  <p><span className="font-semibold">Line:</span> {selection.line}</p>
                  <p><span className="font-semibold">Process:</span> {selection.process}</p>
                  <p className="text-green-600 font-bold mt-2 flex items-center gap-1">
                    <CheckCircle className="w-4 h-4"/> บันทึกผลสำเร็จ
                  </p>
                </div>

                <button onClick={() => window.location.reload()} className="w-full bg-slate-800 text-white p-3 rounded-lg font-bold hover:bg-slate-900 transition">
                  เสร็จสิ้น / ปิดหน้าต่าง
                </button>
              </div>
            ) : (
              <div className="animate-in shake duration-300">
                 <div className="mx-auto bg-red-100 w-20 h-20 rounded-full flex items-center justify-center mb-4">
                  <XCircle className="h-12 w-12 text-red-600" />
                </div>
                <h2 className="text-2xl font-bold text-red-700 mb-2">ไม่ผ่านการทดสอบ</h2>
                <p className="text-slate-600 mb-6">คุณทำได้ {result.score}/{questions.length} คะแนน</p>
                
                <div className="flex items-start justify-start gap-2 text-yellow-800 bg-yellow-50 p-4 rounded-lg mb-6 border border-yellow-200 text-left text-sm">
                  <AlertTriangle className="h-5 w-5 shrink-0" />
                  <span>
                    <strong>เงื่อนไข:</strong> ต้องตอบถูกทุกข้อ (100%) เท่านั้นจึงจะผ่านเกณฑ์ <br/>
                    *ระบบไม่ได้บันทึกผลการสอบครั้งนี้
                  </span>
                </div>

                <button onClick={resetQuiz} className="w-full bg-red-600 text-white p-3 rounded-lg font-bold hover:bg-red-700 transition shadow-md">
                  ทำแบบทดสอบใหม่
                </button>
              </div>
            )}
          </div>
        </div>
      </div>
    );
  }

  return null;
}