<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Morning Quiz - SHELL F.2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- THEME CONFIG --- */
        :root {
            --color-primary: #DD1D21;   /* Shell Red */
            --color-accent: #FBCE07;    /* Shell Yellow */
            --color-bg: #F3F4F6;        /* Light Gray */
            --color-surface: #FFFFFF;
        }

        body {
            font-family: 'Prompt', sans-serif;
            background-color: #e5e5e5; /* Background outside app */
            color: #1f2937;
            -webkit-tap-highlight-color: transparent;
            overflow: hidden; /* Prevent scroll on body, handle in app-shell */
            height: 100vh;
            display: flex;
            justify-content: center;
        }

        /* --- MOBILE APP CONTAINER --- */
        .app-shell {
            width: 100%;
            max-width: 480px;
            height: 100%;
            background: var(--color-bg);
            position: relative;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 0 40px rgba(0,0,0,0.1);
        }

        /* --- UTILITIES --- */
        .hide-scroll::-webkit-scrollbar { display: none; }
        .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; }
        .hidden { display: none !important; }
        
        /* Safe Area for iPhone X+ */
        .safe-pb { padding-bottom: env(safe-area-inset-bottom, 20px); }

        /* --- COMPONENTS --- */
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }

        .btn-primary {
            background: linear-gradient(135deg, #DD1D21 0%, #b91c1c 100%);
            color: white;
            border-radius: 16px;
            padding: 16px;
            font-weight: 600;
            font-size: 1rem;
            box-shadow: 0 8px 20px rgba(221, 29, 33, 0.3);
            transition: transform 0.15s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex; justify-content: center; align-items: center; gap: 8px;
            width: 100%;
        }
        .btn-primary:active { transform: scale(0.96); }
        .btn-primary:disabled { background: #9ca3af; box-shadow: none; opacity: 0.7; cursor: not-allowed; }

        .btn-secondary {
            background: white;
            color: #374151;
            border: 1px solid #e5e7eb;
            border-radius: 16px;
            padding: 14px;
            font-weight: 600;
            width: 100%;
            transition: background 0.1s;
        }
        .btn-secondary:active { background: #f9fafb; }

        .input-modern {
            width: 100%;
            padding: 16px;
            background: #fff;
            border: 2px solid #f3f4f6;
            border-radius: 16px;
            font-size: 1rem;
            outline: none;
            transition: all 0.2s;
            color: #111827;
        }
        .input-modern:focus { border-color: var(--color-accent); box-shadow: 0 0 0 4px rgba(251, 206, 7, 0.1); }
        
        .card {
            background: white;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.02), 0 2px 4px -1px rgba(0, 0, 0, 0.02);
            border: 1px solid #f3f4f6;
        }

        /* --- ANIMATIONS --- */
        .view-section {
            position: absolute;
            top: 0; left: 0; w-full; h-full;
            width: 100%; height: 100%;
            overflow-y: auto;
            background: var(--color-bg);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease;
            opacity: 0;
            pointer-events: none;
            transform: translateX(20px);
            z-index: 10;
            padding-bottom: 80px; /* Space for bottom elements */
        }
        
        .view-section.active {
            opacity: 1;
            pointer-events: auto;
            transform: translateX(0);
            z-index: 20;
        }

        /* Toast */
        #toast-container { position: absolute; top: 20px; left: 0; right: 0; display: flex; justify-content: center; z-index: 100; pointer-events: none; }
        .toast {
            background: rgba(31, 41, 55, 0.95);
            backdrop-filter: blur(4px);
            color: white;
            padding: 12px 24px;
            border-radius: 99px;
            font-size: 0.9rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            transform: translateY(-100%);
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .toast.show { transform: translateY(0); opacity: 1; }

        /* Loader */
        .loader { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid var(--color-primary); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div class="app-shell">
    <!-- CONFIG -->
    <script>
        // *** ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ***
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxy2Mii3h-59JUQd50iUyt4JoKB1rvw_TyzUn9-pkSvYmfADjqTKN92RjNWY9NotDLB/exec";
        const ADMIN_PIN = "1234";
    </script>

    <!-- GLOBAL COMPONENTS -->
    <div id="toast-container"><div id="toast-msg" class="toast">Message</div></div>
    
    <!-- SPLASH SCREEN / LOADER -->
    <div id="screen-loader" class="absolute inset-0 bg-white z-50 flex flex-col items-center justify-center transition-opacity duration-300">
        <div class="w-20 h-20 bg-gradient-to-br from-yellow-400 to-yellow-500 rounded-2xl flex items-center justify-center shadow-lg mb-6">
            <i data-lucide="shield-check" class="w-10 h-10 text-white"></i>
        </div>
        <h1 class="text-2xl font-bold text-slate-800">Morning Quiz</h1>
        <p class="text-xs text-slate-400 font-medium tracking-widest mt-1">SHELL F.2 SYSTEM</p>
        <div class="loader mt-8 w-8 h-8 border-2"></div>
    </div>

    <!-- HEADER (Shared) -->
    <header id="app-header" class="absolute top-0 left-0 right-0 z-30 glass-panel px-5 py-4 flex justify-between items-center transition-transform duration-300">
        <div class="flex items-center gap-3">
            <div class="w-9 h-9 rounded-lg bg-yellow-400 flex items-center justify-center text-white shadow-sm">
                <i data-lucide="activity" class="w-5 h-5"></i>
            </div>
            <div>
                <h1 class="text-base font-bold text-slate-800 leading-none">Morning Quiz</h1>
                <p id="header-status" class="text-[10px] font-bold text-green-600 flex items-center gap-1 mt-0.5">
                    <span class="w-1.5 h-1.5 rounded-full bg-green-500"></span> Online
                </p>
            </div>
        </div>
        <button onclick="adminAuth()" class="w-9 h-9 rounded-full bg-slate-50 text-slate-400 flex items-center justify-center hover:bg-slate-100 active:scale-95 transition">
            <i data-lucide="settings" class="w-5 h-5"></i>
        </button>
    </header>

    <!-- === VIEWS === -->

    <!-- 1. LOGIN SCREEN -->
    <div id="view-login" class="view-section active flex flex-col justify-center px-6">
        <div class="mb-8">
            <span class="inline-block px-3 py-1 bg-yellow-100 text-yellow-800 rounded-full text-[10px] font-bold mb-3 tracking-wide">üëã ‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏ï‡∏≠‡∏ô‡πÄ‡∏ä‡πâ‡∏≤</span>
            <h2 class="text-3xl font-bold text-slate-800 leading-tight">‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏°<br>‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô</h2>
        </div>
        <form onsubmit="handleLogin(event)" class="space-y-4">
            <div>
                <label class="text-xs font-bold text-slate-400 ml-1 uppercase">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
                <div class="relative mt-1">
                    <i data-lucide="user" class="absolute left-4 top-4 w-5 h-5 text-slate-400"></i>
                    <input type="text" id="inp-name" class="input-modern pl-12" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏£‡∏¥‡∏á" required>
                </div>
            </div>
            <div>
                <label class="text-xs font-bold text-slate-400 ml-1 uppercase">‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</label>
                <div class="relative mt-1">
                    <i data-lucide="hash" class="absolute left-4 top-4 w-5 h-5 text-slate-400"></i>
                    <input type="tel" id="inp-id" class="input-modern pl-12" placeholder="‡πÄ‡∏ä‡πà‡∏ô 12345" required>
                </div>
            </div>
            <button type="submit" class="btn-primary mt-6">
                ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô <i data-lucide="arrow-right" class="w-5 h-5"></i>
            </button>
        </form>
    </div>

    <!-- 2. SELECT SCREEN -->
    <div id="view-select" class="view-section pt-24 px-6">
        <div class="mb-6">
            <h2 class="text-xl font-bold text-slate-800">‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô</h2>
            <p class="text-sm text-slate-500" id="user-welcome">‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏Ñ‡∏∏‡∏ì...</p>
        </div>

        <div class="space-y-4">
            <!-- Line Select -->
            <div class="relative">
                <label class="text-[10px] font-bold text-slate-400 ml-1 uppercase">Line ‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï</label>
                <select id="sel-line" class="input-modern appearance-none mt-1" onchange="onLineChange()">
                    <option value="">-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --</option>
                </select>
                <i data-lucide="chevron-down" class="absolute right-4 bottom-4 w-5 h-5 text-slate-400 pointer-events-none"></i>
            </div>
            <!-- Process Select -->
            <div class="relative opacity-50 transition-opacity" id="box-process">
                <label class="text-[10px] font-bold text-slate-400 ml-1 uppercase">Process</label>
                <select id="sel-process" class="input-modern appearance-none mt-1 bg-slate-100" disabled onchange="checkReady()">
                    <option value="">-- ‡∏£‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Line --</option>
                </select>
                <i data-lucide="chevron-down" class="absolute right-4 bottom-4 w-5 h-5 text-slate-400 pointer-events-none"></i>
            </div>
        </div>

        <div class="mt-8">
            <button id="btn-start" class="btn-primary" disabled onclick="startQuiz()">
                ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö
            </button>
            <button onclick="logout()" class="w-full text-center text-xs text-slate-400 font-medium mt-4 p-2">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</button>
        </div>
    </div>

    <!-- 3. QUIZ SCREEN -->
    <div id="view-quiz" class="view-section pt-24 px-6 flex flex-col">
        <div class="flex justify-between items-end mb-6">
            <div>
                <span id="badge-process" class="px-2 py-1 bg-slate-100 rounded-md text-[10px] font-bold text-slate-500 uppercase">PROCESS</span>
                <h2 class="text-xl font-bold text-slate-800 mt-1">‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö</h2>
            </div>
            <div class="flex items-baseline">
                <span class="text-2xl font-black text-red-600" id="txt-q-current">1</span>
                <span class="text-sm text-slate-300 font-bold mx-1">/</span>
                <span class="text-sm text-slate-400 font-bold" id="txt-q-total">-</span>
            </div>
        </div>

        <div id="quiz-list" class="space-y-6 pb-24">
            <!-- Questions Render Here -->
        </div>

        <!-- Floating Action Button for Submit -->
        <div class="fixed bottom-0 left-0 right-0 p-6 bg-gradient-to-t from-white via-white to-transparent safe-pb z-20 max-w-[480px] mx-auto">
            <button onclick="submitQuiz()" class="btn-primary shadow-xl">‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö</button>
        </div>
    </div>

    <!-- 4. RESULT SCREEN -->
    <div id="view-result" class="view-section flex flex-col items-center justify-center px-8 text-center">
        <!-- Dynamic Result Content -->
        <div id="res-content" class="w-full"></div>
        <button onclick="location.reload()" class="btn-secondary mt-8">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
    </div>

    <!-- 5. ADMIN SCREEN -->
    <div id="view-admin" class="view-section pt-24 px-0 bg-gray-50">
        <div class="px-6 mb-4 flex justify-between items-center">
            <h2 class="text-2xl font-bold text-slate-800">Admin Console</h2>
            <button onclick="location.reload()" class="text-xs font-bold text-red-500 bg-red-50 px-3 py-1.5 rounded-full">Exit</button>
        </div>

        <!-- Tabs -->
        <div class="px-6 mb-6">
            <div class="bg-white p-1 rounded-xl flex shadow-sm">
                <button onclick="setAdminTab('dash')" id="tab-dash" class="flex-1 py-2 text-xs font-bold rounded-lg bg-slate-800 text-white transition-all">Overview</button>
                <button onclick="setAdminTab('master')" id="tab-master" class="flex-1 py-2 text-xs font-bold rounded-lg text-slate-400 transition-all">Master Data</button>
                <button onclick="setAdminTab('qs')" id="tab-qs" class="flex-1 py-2 text-xs font-bold rounded-lg text-slate-400 transition-all">Questions</button>
            </div>
        </div>

        <div class="px-6 pb-24 overflow-y-auto h-full">
            <!-- Dash Tab -->
            <div id="admin-dash">
                <div class="bg-slate-800 rounded-3xl p-6 text-white mb-6 relative overflow-hidden shadow-xl">
                    <div class="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full blur-3xl -mr-10 -mt-10"></div>
                    <p class="text-xs text-slate-400 font-medium">Total Submissions</p>
                    <p class="text-5xl font-bold mt-1" id="adm-total">0</p>
                </div>
                <div class="flex justify-between items-center mb-3">
                    <h3 class="font-bold text-slate-700">Recent Activity</h3>
                    <button onclick="fetchDashboard()" class="text-xs text-blue-500"><i data-lucide="rotate-cw" class="w-4 h-4"></i></button>
                </div>
                <div id="adm-list" class="space-y-3"></div>
            </div>

            <!-- Master Tab -->
            <div id="admin-master" class="hidden space-y-6">
                <div>
                    <h3 class="text-sm font-bold text-slate-500 mb-2 uppercase tracking-wider">Lines</h3>
                    <div class="flex gap-2 mb-3">
                        <input id="new-line" class="input-modern py-2 text-sm" placeholder="Add new line...">
                        <button onclick="addMaster('lines')" class="bg-slate-800 text-white w-12 rounded-xl flex items-center justify-center shadow-lg active:scale-95"><i data-lucide="plus" class="w-5 h-5"></i></button>
                    </div>
                    <div id="list-lines" class="flex flex-wrap gap-2"></div>
                </div>
                <div>
                    <h3 class="text-sm font-bold text-slate-500 mb-2 uppercase tracking-wider">Processes</h3>
                    <div class="flex gap-2 mb-3">
                        <input id="new-proc" class="input-modern py-2 text-sm" placeholder="Add new process...">
                        <button onclick="addMaster('processes')" class="bg-slate-800 text-white w-12 rounded-xl flex items-center justify-center shadow-lg active:scale-95"><i data-lucide="plus" class="w-5 h-5"></i></button>
                    </div>
                    <div id="list-processes" class="flex flex-wrap gap-2"></div>
                </div>
            </div>

            <!-- Questions Tab -->
            <div id="admin-qs" class="hidden">
                <div class="sticky top-0 z-10 bg-gray-50 pb-4 pt-2 flex gap-2">
                    <select id="filter-part" onchange="fetchQuestions()" class="flex-1 input-modern py-2 text-sm">
                        <option value="1">‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 1 (‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ)</option>
                        <option value="2">‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 2 (Process)</option>
                        <option value="3">‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 3 (Critical)</option>
                    </select>
                    <button onclick="openQModal()" class="bg-green-600 text-white px-4 rounded-xl shadow-lg active:scale-95 font-bold text-sm flex items-center gap-1">
                        <i data-lucide="plus-circle" class="w-4 h-4"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°
                    </button>
                </div>
                <div id="list-questions" class="space-y-3"></div>
            </div>
        </div>
    </div>

    <!-- === MODALS === -->
    
    <!-- PIN MODAL -->
    <div id="modal-pin" class="fixed inset-0 bg-black/80 z-50 flex items-center justify-center hidden backdrop-blur-sm p-6">
        <div class="bg-white w-full max-w-xs p-6 rounded-3xl text-center shadow-2xl animate-bounce-in">
            <div class="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4 text-gray-400"><i data-lucide="lock"></i></div>
            <h3 class="text-lg font-bold text-slate-800 mb-6">Admin Access</h3>
            <input type="password" id="inp-pin" class="text-center text-3xl font-bold w-full border-b-2 border-gray-200 py-2 mb-8 outline-none tracking-[0.5em]" maxlength="4" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
            <div class="grid grid-cols-2 gap-3">
                <button onclick="closeModal('modal-pin')" class="btn-secondary py-2">Cancel</button>
                <button onclick="verifyPin()" class="bg-slate-800 text-white rounded-xl font-bold py-2">Enter</button>
            </div>
        </div>
    </div>

    <!-- QUESTION MODAL -->
    <div id="modal-q" class="fixed inset-0 bg-black/90 z-50 flex items-end sm:items-center justify-center hidden backdrop-blur-sm">
        <div class="bg-white w-full sm:max-w-md p-6 rounded-t-3xl sm:rounded-3xl max-h-[90vh] overflow-y-auto shadow-2xl animate-slide-up">
            <div class="w-12 h-1.5 bg-gray-200 rounded-full mx-auto mb-6"></div>
            <h3 class="font-bold text-xl mb-6 text-slate-800" id="q-modal-title">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö</h3>
            
            <input type="hidden" id="q-row">
            <input type="hidden" id="q-img-url">
            <input type="hidden" id="q-img-base64">

            <div class="space-y-5">
                <div id="grp-proc">
                    <label class="text-[10px] font-bold text-gray-400 uppercase">Process</label>
                    <select id="q-proc-sel" class="input-modern mt-1"></select>
                </div>
                
                <!-- Image Upload -->
                <div class="border-2 border-dashed border-gray-200 rounded-2xl p-4 text-center cursor-pointer hover:bg-gray-50 relative" onclick="document.getElementById('inp-q-img').click()">
                    <input type="file" id="inp-q-img" class="hidden" accept="image/*" onchange="previewImage(this)">
                    <div id="img-placeholder" class="flex flex-col items-center py-2">
                        <i data-lucide="image-plus" class="w-6 h-6 text-gray-300 mb-2"></i>
                        <span class="text-xs text-gray-400">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)</span>
                    </div>
                    <img id="img-preview" class="hidden w-full h-32 object-contain rounded-lg">
                    <button type="button" id="btn-del-img" class="hidden absolute top-2 right-2 bg-red-100 text-red-500 p-1 rounded-full" onclick="clearImage(event)"><i data-lucide="x" class="w-4 h-4"></i></button>
                </div>

                <div>
                    <label class="text-[10px] font-bold text-gray-400 uppercase">‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°</label>
                    <textarea id="q-text" class="input-modern mt-1" rows="2"></textarea>
                </div>
                <div class="space-y-2">
                    <div class="flex gap-2 items-center"><span class="w-4 text-xs font-bold text-gray-400">A</span><input id="q-opt1" class="input-modern py-2"></div>
                    <div class="flex gap-2 items-center"><span class="w-4 text-xs font-bold text-gray-400">B</span><input id="q-opt2" class="input-modern py-2"></div>
                    <div class="flex gap-2 items-center" id="grp-opt3"><span class="w-4 text-xs font-bold text-gray-400">C</span><input id="q-opt3" class="input-modern py-2"></div>
                </div>
                <div>
                    <label class="text-[10px] font-bold text-green-600 uppercase">‡πÄ‡∏â‡∏•‡∏¢</label>
                    <select id="q-correct" class="input-modern mt-1 border-green-200 bg-green-50 text-green-800 font-bold">
                        <option value="1">‡∏Ç‡πâ‡∏≠ A</option>
                        <option value="2">‡∏Ç‡πâ‡∏≠ B</option>
                        <option value="3">‡∏Ç‡πâ‡∏≠ C</option>
                    </select>
                </div>
            </div>

            <div class="mt-8 flex gap-3 pb-4">
                <button onclick="closeModal('modal-q')" class="btn-secondary">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button onclick="saveQuestion()" class="flex-1 btn-primary" id="btn-save-q">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            </div>
        </div>
    </div>

    <!-- Master Edit Modal -->
    <div id="modal-master" class="fixed inset-0 bg-black/80 z-50 flex items-center justify-center hidden backdrop-blur-sm p-6">
        <div class="bg-white w-full max-w-xs p-6 rounded-3xl shadow-2xl">
            <h3 class="font-bold text-lg mb-4 text-center">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3>
            <input id="inp-master-edit" class="input-modern text-center mb-6">
            <div class="flex gap-3">
                <button onclick="closeModal('modal-master')" class="btn-secondary">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button onclick="submitMasterEdit()" class="btn-primary flex-1">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            </div>
        </div>
    </div>

</div>

<script>
    // --- STATE & HELPERS ---
    const STATE = { lines: [], procs: [], user: null, quiz: [], answers: {}, adminQs: [], masterEdit: null };
    
    const dom = (id) => document.getElementById(id);
    const show = (id) => dom(id)?.classList.remove('hidden');
    const hide = (id) => dom(id)?.classList.add('hidden');
    const toast = (msg, type='success') => {
        const el = dom('toast-msg');
        el.innerHTML = `<i data-lucide="${type=='error'?'alert-circle':'check-circle'}" class="w-4 h-4"></i> ${msg}`;
        el.className = `toast ${type=='error'?'bg-red-600':'bg-slate-800'} text-white px-6 py-3 rounded-full shadow-xl flex items-center gap-2 mx-auto w-fit`;
        el.classList.add('show');
        setTimeout(() => el.classList.remove('show'), 3000);
        lucide.createIcons();
    };
    
    // SAFE SHOW VIEW Function (Prevents the error)
    function showView(viewId) {
        document.querySelectorAll('.view-section').forEach(el => {
            el.classList.remove('active');
            el.style.display = 'none'; // Force hide
        });
        const target = dom(viewId);
        if(target) {
            target.style.display = 'flex';
            // Small delay to allow display:flex to apply before opacity transition
            setTimeout(() => target.classList.add('active'), 10);
            window.scrollTo(0,0);
        }
    }

    // --- INIT ---
    window.onload = () => {
        lucide.createIcons();
        setTimeout(() => {
            hide('screen-loader');
            showView('view-login');
            // Preload data silently
            fetchData(); 
        }, 1500);
    };

    async function fetchData() {
        try {
            const res = await fetch(`${GOOGLE_SCRIPT_URL}?action=getDropdowns`);
            const data = await res.json();
            STATE.lines = data.lines || [];
            STATE.procs = data.processes || [];
            renderDropdowns();
        } catch(e) { console.error("Data Load Error", e); }
    }

    // --- USER LOGIC ---
    function handleLogin(e) {
        e.preventDefault();
        STATE.user = { name: dom('inp-name').value, empId: dom('inp-id').value };
        dom('user-welcome').innerText = `‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ, ${STATE.user.name}`;
        showView('view-select');
    }

    function renderDropdowns() {
        const l = dom('sel-line'); const p = dom('sel-process');
        l.innerHTML = '<option value="">-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --</option>';
        STATE.lines.forEach(x => l.innerHTML += `<option value="${x}">${x}</option>`);
        p.innerHTML = '<option value="">-- ‡∏£‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Line --</option>';
        STATE.procs.forEach(x => p.innerHTML += `<option value="${x}">${x}</option>`);
    }

    function onLineChange() {
        const val = dom('sel-line').value;
        const p = dom('sel-process');
        const box = dom('box-process');
        p.disabled = !val;
        box.style.opacity = val ? '1' : '0.5';
        p.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Process --</option>';
        if(val) STATE.procs.forEach(x => p.innerHTML += `<option value="${x}">${x}</option>`);
        checkReady();
    }

    function checkReady() {
        dom('btn-start').disabled = !(dom('sel-line').value && dom('sel-process').value);
    }

    function logout() { location.reload(); }

    // --- QUIZ LOGIC ---
    async function startQuiz() {
        dom('btn-start').innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...";
        const process = dom('sel-process').value;
        try {
            const res = await fetch(`${GOOGLE_SCRIPT_URL}?action=getQuestions&process=${encodeURIComponent(process)}`);
            const data = await res.json();
            if(!data.questions || data.questions.length === 0) throw new Error("No Questions");
            
            STATE.quiz = data.questions;
            STATE.answers = {};
            
            dom('badge-process').innerText = process;
            dom('txt-q-total').innerText = STATE.quiz.length;
            renderQuizList();
            showView('view-quiz');
            
        } catch(e) {
            alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Ç‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏á");
        }
        dom('btn-start').innerText = "‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö";
    }

    function renderQuizList() {
        const c = dom('quiz-list'); c.innerHTML = '';
        STATE.quiz.forEach((q, idx) => {
            let img = q.image ? `<img src="${q.image}" class="w-full h-48 object-contain bg-white border rounded-xl mb-4">` : '';
            let opts = '';
            q.options.forEach(o => {
                opts += `
                <label class="flex items-center p-4 bg-white border border-gray-100 rounded-xl mb-2 cursor-pointer active:scale-[0.98] transition select-none shadow-sm">
                    <input type="radio" name="q${q.id}" value="${o}" onchange="saveAns('${q.id}', '${o}')" class="w-5 h-5 accent-[#FBCE07] mr-3">
                    <span class="text-sm text-gray-700">${o}</span>
                </label>`;
            });
            c.innerHTML += `
            <div class="mb-8">
                <p class="text-sm font-bold text-gray-400 mb-2">‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà ${idx+1}</p>
                <div class="bg-white p-5 rounded-2xl border border-gray-100 shadow-sm mb-4">
                    ${img}
                    <p class="font-bold text-lg text-slate-800">${q.text}</p>
                </div>
                <div>${opts}</div>
            </div>`;
        });
    }

    function saveAns(id, val) { STATE.answers[id] = val; }

    async function submitQuiz() {
        if(Object.keys(STATE.answers).length < STATE.quiz.length) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏≠‡∏ö‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏Ç‡πâ‡∏≠");
        
        const btn = dom('btn-submit'); btn.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á..."; btn.disabled = true;
        let score = 0;
        STATE.quiz.forEach(q => { if(String(STATE.answers[q.id]).trim() === String(q.correct).trim()) score++; });
        const passed = score === STATE.quiz.length;

        try {
            await fetch(GOOGLE_SCRIPT_URL, {
                method:'POST', 
                body:JSON.stringify({
                    action:'submit', 
                    user:STATE.user, 
                    selection:{line:dom('sel-line').value, process:dom('sel-process').value}, 
                    score, status:passed?'Passed':'Failed'
                })
            });
        } catch(e) { console.error(e); }

        showView('view-result');
        show(passed ? 'result-pass' : 'result-fail');
        dom('res-score').innerText = `${score}/${STATE.quiz.length}`;
        lucide.createIcons();
    }

    // --- ADMIN SYSTEM ---
    function adminAuth() { show('modal-pin'); dom('inp-pin').value=''; dom('inp-pin').focus(); }
    function closeModal(id) { hide(id); }
    
    async function verifyPin() {
        if(dom('inp-pin').value === ADMIN_PIN) {
            hide('modal-pin');
            showView('view-admin');
            setAdminTab('dash');
            // Pre-fetch all admin data
            await Promise.all([fetchDashboard(), fetchMasterData(), fetchQuestions()]);
        } else alert("‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î");
    }

    function setAdminTab(tab) {
        ['dash','master','qs'].forEach(t => {
            hide(`admin-${t}`);
            const btn = dom(`tab-${t}`);
            if(t===tab) { 
                show(`admin-${t}`); 
                btn.classList.add('bg-slate-800','text-white'); btn.classList.remove('text-slate-400');
            } else {
                btn.classList.remove('bg-slate-800','text-white'); btn.classList.add('text-slate-400');
            }
        });
    }

    // Admin: Dashboard
    async function fetchDashboard() {
        try {
            const res = await fetch(`${GOOGLE_SCRIPT_URL}?action=getSummary`);
            const data = await res.json();
            dom('adm-total').innerText = data.total;
            let html = '';
            data.recent.forEach(r => {
                let statusColor = r.status.toLowerCase()=='passed' ? 'text-green-600' : 'text-red-600';
                html += `<div class="flex justify-between p-3 bg-white rounded-xl border border-gray-100">
                    <div><div class="text-sm font-bold text-slate-700">${r.name}</div><div class="text-[10px] text-gray-400">${r.time} ‚Ä¢ ${r.process}</div></div>
                    <div class="text-right"><div class="text-xs font-bold ${statusColor}">${r.status}</div><div class="text-[10px] text-gray-400">Score: ${r.score}</div></div>
                </div>`;
            });
            dom('adm-list').innerHTML = html || '<p class="text-center text-xs text-gray-400">‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤</p>';
        } catch(e){}
    }

    // Admin: Master Data (Safe & Atomic)
    function renderMasterLists() {
        renderList('lines', STATE.lines); renderList('processes', STATE.procs);
    }
    function renderList(key, arr) {
        const el = dom(`list-${key}`); el.innerHTML = '';
        arr.forEach((item, idx) => {
            el.innerHTML += `<span class="inline-flex items-center px-3 py-1.5 bg-white border border-gray-200 rounded-lg text-sm text-slate-600 m-1">
                ${item}
                <button onclick="editMaster('${key}', ${idx})" class="ml-2 text-blue-400"><i data-lucide="pencil" class="w-3 h-3"></i></button>
                <button onclick="delMaster('${key}', ${idx})" class="ml-1 text-red-400"><i data-lucide="x" class="w-3 h-3"></i></button>
            </span>`;
        });
        lucide.createIcons();
    }
    
    async function addMaster(type) {
        const inp = dom(type=='lines'?'new-line':'new-proc');
        const val = inp.value.trim();
        if(!val) return;
        inp.value = '';
        
        // Update UI Immediately
        if(type=='lines') STATE.lines.push(val); else STATE.procs.push(val);
        renderMasterLists();

        // Sync Server
        await fetch(GOOGLE_SCRIPT_URL, { method:'POST', body:JSON.stringify({action:'manageMaster', type, subAction:'add', value:val}) });
    }

    async function delMaster(type, idx) {
        if(!confirm("‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?")) return;
        if(type=='lines') STATE.lines.splice(idx,1); else STATE.procs.splice(idx,1);
        renderMasterLists();
        await fetch(GOOGLE_SCRIPT_URL, { method:'POST', body:JSON.stringify({action:'manageMaster', type, subAction:'delete', index:idx}) });
    }

    function editMaster(key, idx) {
        STATE.masterEdit = { key, idx };
        dom('inp-master-edit').value = (key=='lines' ? STATE.lines[idx] : STATE.procs[idx]);
        show('modal-master');
    }
    async function submitMasterEdit() {
        const val = dom('inp-master-edit').value.trim();
        if(val) {
            const { key, idx } = STATE.masterEdit;
            if(key=='lines') STATE.lines[idx]=val; else STATE.procs[idx]=val;
            renderMasterLists();
            hide('modal-master');
            await fetch(GOOGLE_SCRIPT_URL, { method:'POST', body:JSON.stringify({action:'manageMaster', type:key, subAction:'edit', index:idx, value:val}) });
        }
    }

    // Admin: Questions
    async function fetchQuestions() {
        const part = dom('filter-part').value;
        
        // Setup Modal UI based on Part
        dom('grp-process').classList.toggle('hidden', part=='1');
        dom('grp-opt3').classList.toggle('hidden', part=='1');
        
        // Populate Process Dropdown in Modal
        const sel = dom('q-proc-sel'); sel.innerHTML = '';
        STATE.procs.forEach(x => sel.innerHTML += `<option value="${x}">${x}</option>`);

        try {
            const res = await fetch(`${GOOGLE_SCRIPT_URL}?action=getAllQuestions`);
            const data = await res.json();
            STATE.adminQs = data;
            const list = data['part'+part] || [];
            const c = dom('list-questions');
            c.innerHTML = list.length ? '' : '<p class="text-center text-xs text-gray-400 mt-10">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö</p>';
            
            list.forEach(q => {
                const imgIcon = q.ImageURL ? '<i data-lucide="image" class="w-3 h-3 text-blue-500 ml-2"></i>' : '';
                c.innerHTML += `
                <div class="bg-white p-4 rounded-2xl border border-gray-100 shadow-sm relative group">
                    <div class="flex justify-between mb-2">
                        <div class="flex items-center"><span class="text-[10px] font-bold bg-gray-100 text-gray-500 px-2 py-1 rounded">${part!='1'?q.ProcessName:'General'}</span>${imgIcon}</div>
                        <div class="flex gap-2">
                            <button onclick="editQ(${part}, ${q.row})" class="text-blue-500"><i data-lucide="pencil" class="w-3.5 h-3.5"></i></button>
                            <button onclick="delQ(${part}, ${q.row})" class="text-red-500"><i data-lucide="trash-2" class="w-3.5 h-3.5"></i></button>
                        </div>
                    </div>
                    <p class="text-sm font-bold text-slate-800 mb-2">${q.Question}</p>
                    <div class="text-xs text-green-600">‡πÄ‡∏â‡∏•‡∏¢: ${q.CorrectAnswer}</div>
                </div>`;
            });
            lucide.createIcons();
        } catch(e){}
    }

    // Question Actions
    function previewImage(input) {
        const file = input.files[0];
        if(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                dom('q-img-base64').value = e.target.result;
                dom('img-preview').src = e.target.result;
                show('img-preview'); show('btn-del-img'); hide('img-placeholder');
            };
            reader.readAsDataURL(file);
        }
    }
    function clearImage(e) {
        e.stopPropagation();
        dom('inp-q-img').value=''; dom('q-img-base64').value=''; dom('q-img-url').value='';
        hide('img-preview'); hide('btn-del-img'); show('img-placeholder');
    }

    async function delQ(part, row) {
        if(confirm("‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏ô‡∏µ‡πâ?")) {
            await fetch(GOOGLE_SCRIPT_URL, {method:'POST', body:JSON.stringify({action:'deleteQuestion', part, row})});
            fetchQuestions();
        }
    }

    let qEditRow = null;
    function openQModal() {
        qEditRow = null;
        dom('q-modal-title').innerText = "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡πÉ‡∏´‡∏°‡πà";
        dom('q-text').value = ''; dom('q-opt1').value = ''; dom('q-opt2').value = ''; dom('q-opt3').value = '';
        clearImage({stopPropagation:()=>{}});
        show('modal-q');
    }

    function editQ(part, row) {
        const q = STATE.adminQs['part'+part].find(x=>x.row==row);
        if(q) {
            qEditRow = row;
            dom('q-modal-title').innerText = "‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö";
            dom('q-text').value = q.Question;
            dom('q-opt1').value = q.Option1; dom('q-opt2').value = q.Option2; 
            if(part!=1) { dom('q-opt3').value = q.Option3; dom('q-proc-sel').value = q.ProcessName; }
            
            if(q.ImageURL) {
                dom('q-img-url').value = q.ImageURL;
                dom('img-preview').src = q.ImageURL;
                show('img-preview'); show('btn-del-img'); hide('img-placeholder');
            } else clearImage({stopPropagation:()=>{}});
            
            show('modal-q');
        }
    }

    async function saveQuestion() {
        const btn = dom('btn-save-q'); btn.innerText="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å..."; btn.disabled=true;
        const part = dom('filter-part').value;
        const body = {
            action: qEditRow!==null?'editQuestion':'addQuestion', part, row: qEditRow,
            process: part==1?'':dom('q-proc-sel').value,
            question: dom('q-text').value,
            opt1: dom('q-opt1').value, opt2: dom('q-opt2').value, opt3: dom('q-opt3').value,
            newImageBase64: dom('q-img-base64').value, currentImage: dom('q-img-url').value
        };
        
        const idx = dom('q-correct').value;
        body.correct = [body.opt1, body.opt2, body.opt3][parseInt(idx)-1];

        if(!body.question || !body.opt1 || !body.opt2) { btn.disabled=false; return alert("‡∏Å‡∏£‡∏≠‡∏Å‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö"); }

        await fetch(GOOGLE_SCRIPT_URL, {method:'POST', body:JSON.stringify(body)});
        hide('modal-q'); fetchQuestions();
        btn.innerText="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"; btn.disabled=false;
    }

</script>
</body>
</html>

