<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Morning Quiz - SHELL F.2</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Google Fonts -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap');
        
        body { 
            font-family: 'Prompt', sans-serif; 
            background-color: #f0f2f5;
            -webkit-tap-highlight-color: transparent;
        }

        /* Mobile App Container Style */
        .app-container {
            max-width: 480px; /* Mobile width constraint */
            margin: 0 auto;
            min-height: 100vh;
            background: white;
            box-shadow: 0 0 20px rgba(0,0,0,0.05);
            position: relative;
            overflow-x: hidden;
        }

        /* Smooth Transitions */
        .fade-in { animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        .slide-up { animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .hidden { display: none !important; }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }

        /* Shell Brand Colors */
        .bg-shell-yellow { background-color: #FBCE07; }
        .text-shell-red { color: #DD1D21; }
        .bg-shell-red { background-color: #DD1D21; }
        .border-shell-yellow { border-color: #FBCE07; }

        /* Input Style */
        .input-modern {
            width: 100%;
            padding: 14px 16px;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            background: #f8fafc;
            transition: all 0.2s;
            font-size: 1rem;
        }
        .input-modern:focus {
            outline: none;
            border-color: #FBCE07;
            background: white;
            box-shadow: 0 0 0 3px rgba(251, 206, 7, 0.2);
        }

        /* Button Modern */
        .btn-primary {
            background: linear-gradient(135deg, #DD1D21 0%, #b91c1c 100%);
            color: white;
            padding: 14px;
            border-radius: 14px;
            font-weight: 600;
            width: 100%;
            box-shadow: 0 4px 12px rgba(221, 29, 33, 0.3);
            transition: transform 0.1s;
        }
        .btn-primary:active { transform: scale(0.98); }
        .btn-primary:disabled { background: #cbd5e1; box-shadow: none; cursor: not-allowed; }

        .btn-secondary {
            background: #fff;
            color: #334155;
            border: 1px solid #e2e8f0;
            padding: 12px;
            border-radius: 12px;
            font-weight: 500;
            width: 100%;
        }

        /* Dashboard Card */
        .stat-card {
            background: white;
            border-radius: 16px;
            padding: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.03);
            border: 1px solid #f1f5f9;
        }
    </style>
</head>
<body>

    <div class="app-container">
        
        <!-- CONFIGURATION -->
        <script>
            // --- นำ Web App URL ที่ได้จากการ Deploy Google Apps Script มาใส่ตรงนี้ ---
            const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwJxaPVPAID31W_i3HMZ_WRfq-j3AqoFKdPDksS5ftp5cR7nWyLlD66G871zsoForzV/exec"; 
            const ADMIN_PIN = "1234"; // รหัสผ่าน Admin (เปลี่ยนได้ตามต้องการ)
        </script>

        <!-- APP HEADER -->
        <header class="bg-shell-yellow px-6 py-5 rounded-b-[30px] shadow-sm relative z-20">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="font-bold text-2xl text-slate-900 flex items-center gap-2">
                        <i data-lucide="shield-check" class="text-shell-red w-7 h-7"></i>
                        Morning Quiz
                    </h1>
                    <p class="text-xs font-semibold text-slate-700 mt-1 opacity-80">SHELL F.2 Safety System</p>
                </div>
                <!-- Admin Toggle -->
                <button onclick="toggleAdminLogin()" class="p-2 bg-white/30 rounded-full hover:bg-white/50 transition">
                    <i data-lucide="settings" class="w-5 h-5 text-slate-800"></i>
                </button>
            </div>
            
            <!-- User Status Card -->
            <div id="header-user-card" class="hidden mt-4 bg-white/90 backdrop-blur p-3 rounded-xl flex items-center justify-between shadow-sm">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-slate-100 rounded-full flex items-center justify-center">
                        <i data-lucide="user" class="w-5 h-5 text-slate-500"></i>
                    </div>
                    <div>
                        <p id="display-name" class="font-bold text-sm text-slate-800 leading-tight">User</p>
                        <p id="display-empid" class="text-xs text-slate-500">ID: -</p>
                    </div>
                </div>
                <div id="status-badge" class="text-[10px] px-2 py-1 rounded-full bg-green-100 text-green-700 font-bold flex items-center gap-1">
                    <div class="w-2 h-2 rounded-full bg-green-500"></div> Online
                </div>
            </div>
        </header>

        <!-- MAIN CONTENT AREA -->
        <main class="p-6 pb-24 relative z-10">

            <!-- 1. LOGIN SECTION -->
            <section id="step-login" class="slide-up">
                <div class="text-center mb-8 mt-4">
                    <div class="inline-flex items-center justify-center w-20 h-20 bg-red-50 rounded-full mb-4">
                        <i data-lucide="log-in" class="w-10 h-10 text-shell-red"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-slate-800">ลงทะเบียนเข้าสอบ</h2>
                    <p class="text-slate-500 text-sm mt-2">กรุณากรอกข้อมูลเพื่อเริ่มทำแบบทดสอบ</p>
                </div>

                <form id="login-form" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1.5 ml-1">ชื่อ-นามสกุล</label>
                        <input type="text" id="input-name" required class="input-modern" placeholder="เช่น สมชาย ใจดี">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1.5 ml-1">รหัสพนักงาน</label>
                        <input type="tel" id="input-empid" required class="input-modern" placeholder="เช่น 12345">
                    </div>
                    <button type="submit" class="btn-primary mt-4 flex items-center justify-center gap-2">
                        เข้าสู่ระบบ <i data-lucide="arrow-right" class="w-5 h-5"></i>
                    </button>
                </form>
            </section>

            <!-- 2. SELECT SECTION -->
            <section id="step-select" class="hidden slide-up">
                <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-1 mb-6">
                    <div class="p-4 border-b border-slate-50">
                        <h2 class="font-bold text-lg text-slate-800">เลือกพื้นที่ปฏิบัติงาน</h2>
                    </div>
                    <div class="p-4 space-y-5">
                        <div>
                            <label class="text-sm font-medium text-slate-600 mb-2 block">Line (ไลน์การผลิต)</label>
                            <div class="relative">
                                <select id="select-line" class="input-modern appearance-none">
                                    <option value="">-- กรุณาเลือก --</option>
                                </select>
                                <i data-lucide="chevron-down" class="absolute right-4 top-4 w-5 h-5 text-slate-400 pointer-events-none"></i>
                            </div>
                        </div>

                        <div>
                            <label class="text-sm font-medium text-slate-600 mb-2 block">Process (กระบวนการ)</label>
                            <div class="relative">
                                <select id="select-process" disabled class="input-modern appearance-none bg-slate-100 text-slate-400">
                                    <option value="">-- รอเลือก Line --</option>
                                </select>
                                <i data-lucide="chevron-down" class="absolute right-4 top-4 w-5 h-5 text-slate-400 pointer-events-none"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="mock-warning" class="hidden mb-6 p-4 bg-yellow-50 rounded-xl border border-yellow-100 flex gap-3">
                    <i data-lucide="wifi-off" class="w-5 h-5 text-yellow-600 shrink-0 mt-0.5"></i>
                    <div class="text-sm text-yellow-800">
                        <strong>Offline Mode:</strong> ไม่สามารถเชื่อมต่อระบบได้ ข้อมูลจะใช้ชุดจำลอง
                    </div>
                </div>

                <button id="btn-start-quiz" disabled class="btn-primary flex justify-center items-center gap-2">
                    เริ่มทำแบบทดสอบ <i data-lucide="play-circle" class="w-5 h-5"></i>
                </button>
            </section>

            <!-- 3. QUIZ SECTION -->
            <section id="step-quiz" class="hidden slide-up">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="font-bold text-lg text-slate-800">แบบทดสอบ</h2>
                    <span class="text-xs bg-slate-100 text-slate-600 px-2 py-1 rounded-md" id="quiz-process-tag"></span>
                </div>

                <div id="questions-container" class="space-y-6">
                    <!-- Questions Injected Here -->
                </div>

                <div class="mt-8 pt-4 border-t border-slate-100">
                    <button id="btn-submit-quiz" class="btn-primary">ส่งคำตอบ</button>
                </div>
            </section>

            <!-- 4. RESULT SECTION -->
            <section id="step-result" class="hidden slide-up text-center pt-8">
                <!-- Pass State -->
                <div id="result-pass" class="hidden">
                    <div class="w-24 h-24 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6 shadow-sm">
                        <i data-lucide="check" class="w-12 h-12 text-green-600"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-slate-800 mb-2">ผ่านการทดสอบ!</h2>
                    <p class="text-slate-500 mb-8">คุณมีความพร้อมในการปฏิบัติงาน</p>
                    
                    <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 text-left mb-6">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm text-slate-500">คะแนนที่ได้</span>
                            <span class="font-bold text-xl text-green-600 score-display">5/5</span>
                        </div>
                        <div class="h-2 bg-slate-100 rounded-full overflow-hidden">
                            <div class="h-full bg-green-500 w-full"></div>
                        </div>
                    </div>
                </div>

                <!-- Fail State -->
                <div id="result-fail" class="hidden">
                    <div class="w-24 h-24 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-6 shadow-sm">
                        <i data-lucide="x" class="w-12 h-12 text-red-600"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-slate-800 mb-2">ไม่ผ่านเกณฑ์</h2>
                    <p class="text-slate-500 mb-8">ต้องตอบถูกทุกข้อ (100%)</p>

                    <div class="bg-red-50 p-4 rounded-xl text-red-700 text-sm mb-6 flex gap-3 text-left">
                        <i data-lucide="alert-circle" class="w-5 h-5 shrink-0"></i>
                        <span>กรุณาทบทวนความรู้และทำแบบทดสอบใหม่อีกครั้ง</span>
                    </div>
                </div>

                <button onclick="location.reload()" class="btn-secondary">กลับหน้าหลัก</button>
            </section>

            <!-- 5. ADMIN LOGIN OVERLAY -->
            <div id="admin-login-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
                <div class="bg-white w-full max-w-xs p-6 rounded-2xl shadow-2xl animate-bounce-in">
                    <div class="text-center mb-6">
                        <div class="w-12 h-12 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-3">
                            <i data-lucide="lock" class="w-6 h-6 text-slate-700"></i>
                        </div>
                        <h3 class="font-bold text-lg">Admin Access</h3>
                        <p class="text-xs text-slate-400">กรุณากรอกรหัสผ่านเพื่อแก้ไขข้อมูล</p>
                    </div>
                    <input type="password" id="admin-pin-input" class="input-modern text-center tracking-widest text-xl mb-4" placeholder="PIN" maxlength="4">
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="closeAdminLogin()" class="btn-secondary">ยกเลิก</button>
                        <button onclick="checkAdminLogin()" class="btn-primary bg-slate-800">ยืนยัน</button>
                    </div>
                </div>
            </div>

            <!-- 6. ADMIN DASHBOARD -->
            <section id="step-admin" class="hidden slide-up pb-20">
                <div class="bg-slate-800 text-white p-6 rounded-2xl mb-6 shadow-lg">
                    <div class="flex justify-between items-start mb-4">
                        <h2 class="text-xl font-bold">Admin Dashboard</h2>
                        <button onclick="exitAdmin()" class="bg-white/20 p-2 rounded-lg hover:bg-white/30">
                            <i data-lucide="log-out" class="w-4 h-4"></i>
                        </button>
                    </div>
                    <div class="flex gap-2 overflow-x-auto pb-2">
                        <button onclick="switchAdminTab('dashboard')" id="tab-dashboard" class="flex-1 py-2 px-3 rounded-lg text-sm font-medium bg-white text-slate-900 transition whitespace-nowrap">Dashboard</button>
                        <button onclick="switchAdminTab('master')" id="tab-master" class="flex-1 py-2 px-3 rounded-lg text-sm font-medium bg-slate-700 text-slate-300 transition whitespace-nowrap">Master Data</button>
                        <button onclick="switchAdminTab('questions')" id="tab-questions" class="flex-1 py-2 px-3 rounded-lg text-sm font-medium bg-slate-700 text-slate-300 transition whitespace-nowrap">Questions</button>
                    </div>
                </div>

                <!-- Tab: Dashboard Summary -->
                <div id="admin-view-dashboard" class="space-y-6">
                    <!-- Stats Cards -->
                    <div class="grid grid-cols-2 gap-4">
                        <div class="stat-card">
                            <div class="flex items-center gap-2 mb-2">
                                <i data-lucide="users" class="w-4 h-4 text-blue-500"></i>
                                <span class="text-xs text-slate-500">สอบทั้งหมด</span>
                            </div>
                            <p class="text-2xl font-bold text-slate-800" id="dash-total">-</p>
                        </div>
                        <div class="stat-card">
                            <div class="flex items-center gap-2 mb-2">
                                <i data-lucide="check-circle" class="w-4 h-4 text-green-500"></i>
                                <span class="text-xs text-slate-500">ผ่านเกณฑ์</span>
                            </div>
                            <p class="text-2xl font-bold text-green-600" id="dash-passed">-</p>
                        </div>
                    </div>

                    <!-- Pass Rate -->
                    <div class="stat-card p-5">
                        <h3 class="font-bold text-slate-800 mb-3 text-sm">อัตราการผ่าน (Pass Rate)</h3>
                        <div class="flex items-center gap-3 mb-2">
                            <div class="flex-1 h-3 bg-red-100 rounded-full overflow-hidden flex">
                                <div id="dash-rate-bar" class="bg-green-500 h-full transition-all duration-500" style="width: 0%"></div>
                            </div>
                            <span class="text-xs font-bold text-slate-600" id="dash-rate-text">0%</span>
                        </div>
                        <div class="flex justify-between text-xs text-slate-400">
                             <span>ไม่ผ่าน: <span id="dash-failed">0</span></span>
                             <span>รวม: <span id="dash-total-sub">0</span></span>
                        </div>
                    </div>

                    <!-- Recent Activity -->
                    <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-100">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-slate-800 text-sm">การสอบล่าสุด</h3>
                            <button onclick="fetchDashboardData()" class="text-xs text-blue-600 bg-blue-50 px-2 py-1 rounded hover:bg-blue-100 flex items-center gap-1">
                                <i data-lucide="rotate-cw" class="w-3 h-3"></i> รีเฟรช
                            </button>
                        </div>
                        <div class="space-y-3" id="dash-recent-list">
                            <div class="text-center text-slate-400 text-xs py-4">กำลังโหลดข้อมูล...</div>
                        </div>
                    </div>
                </div>

                <!-- Tab: Master Data -->
                <div id="admin-view-master" class="hidden space-y-6">
                    <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-100">
                        <h3 class="font-bold text-slate-800 mb-3 flex items-center gap-2">
                            <i data-lucide="layers" class="w-5 h-5 text-blue-500"></i> จัดการ Lines
                        </h3>
                        <textarea id="edit-lines" rows="4" class="input-modern font-mono text-sm" placeholder="Line A, Line B, Line C... (คั่นด้วยจุลภาค)"></textarea>
                        <p class="text-xs text-slate-400 mt-2">*ใส่ชื่อ Line คั่นด้วยเครื่องหมายจุลภาค (,)</p>
                    </div>
                    <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-100">
                        <h3 class="font-bold text-slate-800 mb-3 flex items-center gap-2">
                            <i data-lucide="refresh-cw" class="w-5 h-5 text-purple-500"></i> จัดการ Processes
                        </h3>
                        <textarea id="edit-processes" rows="4" class="input-modern font-mono text-sm" placeholder="Process 1, Process 2..."></textarea>
                    </div>
                    <button onclick="saveMasterData()" id="btn-save-master" class="btn-primary bg-slate-800">บันทึกข้อมูล Master</button>
                </div>

                <!-- Tab: Add Question -->
                <div id="admin-view-questions" class="hidden space-y-5">
                    <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-100">
                        <h3 class="font-bold text-slate-800 mb-4 border-b pb-2">เพิ่มข้อสอบใหม่</h3>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="text-xs font-bold text-slate-500 uppercase">ส่วนของข้อสอบ</label>
                                <select id="new-q-part" class="input-modern" onchange="toggleProcessSelect()">
                                    <option value="1">ส่วนที่ 1 (ทั่วไป - สุ่ม 2 ข้อ)</option>
                                    <option value="2">ส่วนที่ 2 (Process - สุ่ม 2 ข้อ)</option>
                                    <option value="3">ส่วนที่ 3 (Critical - สุ่ม 1 ข้อ)</option>
                                </select>
                            </div>

                            <div id="new-q-process-wrapper" class="hidden">
                                <label class="text-xs font-bold text-slate-500 uppercase">สำหรับ Process</label>
                                <select id="new-q-process" class="input-modern">
                                    <!-- Populated by JS -->
                                </select>
                            </div>

                            <div>
                                <label class="text-xs font-bold text-slate-500 uppercase">คำถาม</label>
                                <textarea id="new-q-text" rows="2" class="input-modern" placeholder="พิมพ์คำถามที่นี่..."></textarea>
                            </div>

                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="text-xs font-bold text-slate-500">ตัวเลือก 1 (ก)</label>
                                    <input type="text" id="opt-1" class="input-modern" placeholder="ตัวเลือก 1">
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-slate-500">ตัวเลือก 2 (ข)</label>
                                    <input type="text" id="opt-2" class="input-modern" placeholder="ตัวเลือก 2">
                                </div>
                                <div class="col-span-2 grid grid-cols-2 gap-3" id="extra-options">
                                    <div>
                                        <label class="text-xs font-bold text-slate-500">ตัวเลือก 3 (ค)</label>
                                        <input type="text" id="opt-3" class="input-modern" placeholder="ตัวเลือก 3">
                                    </div>
                                    <!-- Option 4 can be added if needed, sticking to 3 for parts 2/3 -->
                                </div>
                            </div>

                            <div>
                                <label class="text-xs font-bold text-slate-500 uppercase">คำตอบที่ถูกต้อง</label>
                                <select id="new-q-correct" class="input-modern bg-green-50 border-green-200">
                                    <option value="1">ตัวเลือกที่ 1</option>
                                    <option value="2">ตัวเลือกที่ 2</option>
                                    <option value="3">ตัวเลือกที่ 3</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <button onclick="saveNewQuestion()" id="btn-save-question" class="btn-primary bg-slate-800">บันทึกข้อสอบ</button>
                </div>
            </section>

        </main>
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        // --- CORE STATE ---
        let state = {
            user: { name: '', empId: '' },
            selection: { line: '', process: '' },
            questions: [],
            answers: {},
            lines: [],
            processes: [],
            isMock: false,
            isAdmin: false
        };

        // --- FALLBACK DATA ---
        const FALLBACK_DATA = {
            lines: ["Line A", "Line B", "Line C"],
            processes: Array.from({ length: 5 }, (_, i) => `Process ${i + 1}`)
        };

        // --- INITIALIZATION ---
        lucide.createIcons();

        // --- NAVIGATION ---
        const sections = {
            login: document.getElementById('step-login'),
            select: document.getElementById('step-select'),
            quiz: document.getElementById('step-quiz'),
            result: document.getElementById('step-result'),
            admin: document.getElementById('step-admin')
        };

        function showSection(name) {
            Object.values(sections).forEach(el => el.classList.add('hidden'));
            sections[name].classList.remove('hidden');
            window.scrollTo(0,0);
            lucide.createIcons();
        }

        function setStatus(status) {
            const badge = document.getElementById('status-badge');
            const warning = document.getElementById('mock-warning');
            
            if (status === 'connected') {
                badge.className = "text-[10px] px-2 py-1 rounded-full bg-green-100 text-green-700 font-bold flex items-center gap-1";
                badge.innerHTML = `<div class="w-2 h-2 rounded-full bg-green-500"></div> Online`;
                warning.classList.add('hidden');
                state.isMock = false;
            } else {
                badge.className = "text-[10px] px-2 py-1 rounded-full bg-yellow-100 text-yellow-700 font-bold flex items-center gap-1";
                badge.innerHTML = `<div class="w-2 h-2 rounded-full bg-yellow-500"></div> Offline`;
                warning.classList.remove('hidden');
                state.isMock = true;
            }
        }

        // --- USER FLOW ---
        
        // 1. Login
        document.getElementById('login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const name = document.getElementById('input-name').value.trim();
            const empId = document.getElementById('input-empid').value.trim();
            if(name && empId) {
                state.user = { name, empId };
                document.getElementById('header-user-card').classList.remove('hidden');
                document.getElementById('display-name').innerText = name;
                document.getElementById('display-empid').innerText = `ID: ${empId}`;
                showSection('select');
                fetchMasterData();
            }
        });

        // 2. Fetch Master Data
        async function fetchMasterData() {
            try {
                if(!GOOGLE_SCRIPT_URL) throw new Error("No URL");
                
                // Fetch Dropdowns
                const res = await fetch(`${GOOGLE_SCRIPT_URL}?action=getDropdowns`);
                const text = await res.text();
                let data;
                try { data = JSON.parse(text); } catch(e) { throw new Error("Invalid JSON"); }

                state.lines = (data.lines && data.lines.length) ? data.lines : FALLBACK_DATA.lines;
                state.processes = (data.processes && data.processes.length) ? data.processes : FALLBACK_DATA.processes;
                setStatus('connected');

            } catch(e) {
                console.warn("Using fallback data", e);
                state.lines = FALLBACK_DATA.lines;
                state.processes = FALLBACK_DATA.processes;
                setStatus('offline');
            } finally {
                populateDropdown('select-line', state.lines);
                populateDropdown('select-process', state.processes);
                populateDropdown('new-q-process', state.processes); // For Admin
                
                // Populate Admin Textareas
                document.getElementById('edit-lines').value = state.lines.join(', ');
                document.getElementById('edit-processes').value = state.processes.join(', ');
            }
        }

        function populateDropdown(id, items) {
            const select = document.getElementById(id);
            const firstOpt = select.options[0];
            select.innerHTML = '';
            select.appendChild(firstOpt);
            items.forEach(item => {
                const opt = document.createElement('option');
                opt.value = item;
                opt.innerText = item;
                select.appendChild(opt);
            });
        }

        // 3. Select Logic
        document.getElementById('select-line').addEventListener('change', (e) => {
            state.selection.line = e.target.value;
            const procSelect = document.getElementById('select-process');
            procSelect.disabled = !e.target.value;
            if(!e.target.value) {
                procSelect.classList.add('bg-slate-100', 'text-slate-400');
            } else {
                procSelect.classList.remove('bg-slate-100', 'text-slate-400');
            }
            checkStartBtn();
        });

        document.getElementById('select-process').addEventListener('change', (e) => {
            state.selection.process = e.target.value;
            checkStartBtn();
        });

        function checkStartBtn() {
            document.getElementById('btn-start-quiz').disabled = !(state.selection.line && state.selection.process);
        }

        // 4. Fetch & Start Quiz
        document.getElementById('btn-start-quiz').addEventListener('click', async () => {
            const btn = document.getElementById('btn-start-quiz');
            btn.innerHTML = `<span class="animate-spin">⌛</span> กำลังโหลด...`;
            btn.disabled = true;

            try {
                let questions = [];
                if(state.isMock) {
                    await new Promise(r => setTimeout(r, 800));
                    questions = getMockQuestions();
                } else {
                    const url = `${GOOGLE_SCRIPT_URL}?action=getQuestions&line=${encodeURIComponent(state.selection.line)}&process=${encodeURIComponent(state.selection.process)}`;
                    const res = await fetch(url);
                    const data = await res.json();
                    if(data.error) throw new Error(data.error);
                    questions = data.questions;
                }
                
                state.questions = questions;
                state.answers = {};
                renderQuiz();
                document.getElementById('quiz-process-tag').innerText = state.selection.process;
                showSection('quiz');

            } catch(e) {
                alert("เกิดข้อผิดพลาดในการโหลดข้อสอบ: " + e.message);
            } finally {
                btn.innerHTML = `เริ่มทำแบบทดสอบ <i data-lucide="play-circle" class="w-5 h-5"></i>`;
                btn.disabled = false;
            }
        });

        function renderQuiz() {
            const container = document.getElementById('questions-container');
            container.innerHTML = '';
            state.questions.forEach((q, idx) => {
                const div = document.createElement('div');
                div.className = 'bg-white p-5 rounded-2xl shadow-sm border border-slate-100';
                
                let optionsHTML = '';
                q.options.forEach((opt, optIdx) => {
                    optionsHTML += `
                        <label class="flex items-center p-3.5 rounded-xl border border-slate-100 cursor-pointer transition active:scale-95 hover:bg-slate-50 option-label" id="lbl-${idx}-${optIdx}">
                            <div class="relative flex items-center justify-center w-5 h-5 rounded-full border-2 border-slate-300 mr-3 shrink-0">
                                <input type="radio" name="q_${idx}" class="opacity-0 absolute inset-0 cursor-pointer" onchange="handleAnswer(${idx}, ${optIdx})">
                                <div class="w-2.5 h-2.5 bg-shell-yellow rounded-full hidden check-indicator"></div>
                            </div>
                            <span class="text-slate-700 text-sm font-medium leading-snug">${opt}</span>
                        </label>
                    `;
                });

                div.innerHTML = `
                    <div class="mb-4">
                        <span class="text-[10px] font-bold tracking-wider text-slate-400 uppercase">Question ${idx+1}</span>
                        <h3 class="text-base font-semibold text-slate-800 mt-1">${q.text}</h3>
                    </div>
                    <div class="space-y-2.5" id="options-group-${idx}">${optionsHTML}</div>
                `;
                container.appendChild(div);
            });
        }

        window.handleAnswer = (qIdx, optIdx) => {
            const q = state.questions[qIdx];
            state.answers[q.id] = q.options[optIdx];

            // UI Update
            const group = document.getElementById(`options-group-${qIdx}`);
            group.querySelectorAll('.option-label').forEach(el => {
                el.classList.remove('border-shell-yellow', 'bg-yellow-50/50');
                el.querySelector('.border-2').classList.remove('border-shell-yellow');
                el.querySelector('.check-indicator').classList.add('hidden');
            });
            const selected = document.getElementById(`lbl-${qIdx}-${optIdx}`);
            selected.classList.add('border-shell-yellow', 'bg-yellow-50/50');
            selected.querySelector('.border-2').classList.add('border-shell-yellow');
            selected.querySelector('.check-indicator').classList.remove('hidden');
        };

        // 5. Submit
        document.getElementById('btn-submit-quiz').addEventListener('click', async () => {
            if(Object.keys(state.answers).length < state.questions.length) {
                alert("กรุณาทำข้อสอบให้ครบทุกข้อ");
                return;
            }

            const btn = document.getElementById('btn-submit-quiz');
            btn.innerHTML = `<span class="animate-spin">⌛</span> กำลังประมวลผล...`;
            btn.disabled = true;

            let score = 0;
            state.questions.forEach(q => {
                if(normalize(state.answers[q.id]) === normalize(q.correct)) score++;
            });

            const passed = (score === state.questions.length);

            // Send Result to GAS
            if(passed && !state.isMock) {
                try {
                    await fetch(GOOGLE_SCRIPT_URL, {
                        method: 'POST',
                        body: JSON.stringify({
                            action: 'submit',
                            user: state.user,
                            selection: state.selection,
                            score, 
                            total: state.questions.length,
                            status: 'Passed'
                        })
                    });
                } catch(e) { console.error(e); }
            }

            // Show Result
            document.querySelector('.score-display').innerText = `${score}/${state.questions.length}`;
            document.getElementById('result-pass').classList.toggle('hidden', !passed);
            document.getElementById('result-fail').classList.toggle('hidden', passed);
            showSection('result');
            
            btn.innerHTML = "ส่งคำตอบ";
            btn.disabled = false;
        });

        // --- ADMIN LOGIC ---

        function toggleAdminLogin() {
            document.getElementById('admin-login-modal').classList.remove('hidden');
            document.getElementById('admin-pin-input').value = '';
            document.getElementById('admin-pin-input').focus();
        }

        function closeAdminLogin() {
            document.getElementById('admin-login-modal').classList.add('hidden');
        }

        function checkAdminLogin() {
            const pin = document.getElementById('admin-pin-input').value;
            if(pin === ADMIN_PIN) {
                closeAdminLogin();
                showSection('admin');
                state.isAdmin = true;
                // Load Dashboard by default
                switchAdminTab('dashboard');
                fetchDashboardData();
            } else {
                alert("รหัสผ่านไม่ถูกต้อง");
            }
        }

        function exitAdmin() {
            state.isAdmin = false;
            showSection('login');
        }

        function switchAdminTab(tab) {
            const tabs = ['dashboard', 'master', 'questions'];
            tabs.forEach(t => {
                const btn = document.getElementById(`tab-${t}`);
                const view = document.getElementById(`admin-view-${t}`);
                if (t === tab) {
                    btn.classList.replace('bg-slate-700', 'bg-white');
                    btn.classList.replace('text-slate-300', 'text-slate-900');
                    view.classList.remove('hidden');
                } else {
                    btn.classList.replace('bg-white', 'bg-slate-700');
                    btn.classList.replace('text-slate-900', 'text-slate-300');
                    view.classList.add('hidden');
                }
            });
        }

        async function fetchDashboardData() {
            const listContainer = document.getElementById('dash-recent-list');
            listContainer.innerHTML = '<div class="text-center text-slate-400 text-xs py-4">กำลังโหลดข้อมูล...</div>';

            let data = null;

            if (!state.isMock) {
                try {
                    // Try to fetch real summary if action exists on backend
                    // If not implemented on backend, we might simulate or fail gracefully
                    // For now, we assume backend might not support it yet, so we use mock logic fallback
                    // or user needs to add 'getSummary' to GAS
                    // Uncomment below if backend supports it:
                    // const res = await fetch(`${GOOGLE_SCRIPT_URL}?action=getSummary`);
                    // data = await res.json();
                    
                    // Since backend code isn't provided in context to have changed, I will fallback to mock
                    // But in a real scenario, you'd fetch here.
                    throw new Error("Backend summary not implemented yet"); 
                } catch(e) {
                    console.log("Fetching summary failed or not implemented, using mock.");
                }
            }

            if (!data) {
                // Mock Data for Dashboard
                data = {
                    total: 124,
                    passed: 108,
                    failed: 16,
                    recent: [
                        { name: 'สมชาย รักดี', line: 'Line A', score: '5/5', status: 'Passed', time: '10:30' },
                        { name: 'วิชัย ใจมั่น', line: 'Line B', score: '4/5', status: 'Failed', time: '10:15' },
                        { name: 'กานดา มีสุข', line: 'Line A', score: '5/5', status: 'Passed', time: '09:45' },
                        { name: 'มานะ อดทน', line: 'Line C', score: '5/5', status: 'Passed', time: '09:30' },
                        { name: 'ชูใจ ใฝ่ดี', line: 'Line B', score: '3/5', status: 'Failed', time: '09:10' }
                    ]
                };
            }

            // Update UI
            document.getElementById('dash-total').innerText = data.total;
            document.getElementById('dash-passed').innerText = data.passed;
            document.getElementById('dash-failed').innerText = data.failed;
            document.getElementById('dash-total-sub').innerText = data.total;
            
            const passRate = Math.round((data.passed / data.total) * 100) || 0;
            document.getElementById('dash-rate-text').innerText = `${passRate}%`;
            document.getElementById('dash-rate-bar').style.width = `${passRate}%`;

            // Render List
            listContainer.innerHTML = '';
            data.recent.forEach(item => {
                const isPass = item.status === 'Passed';
                const div = document.createElement('div');
                div.className = 'flex items-center justify-between p-3 rounded-lg border border-slate-50 bg-slate-50/50';
                div.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-full flex items-center justify-center ${isPass ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-600'}">
                            <i data-lucide="${isPass ? 'check' : 'x'}" class="w-4 h-4"></i>
                        </div>
                        <div>
                            <p class="text-sm font-bold text-slate-700 leading-tight">${item.name}</p>
                            <p class="text-[10px] text-slate-400">${item.line} • ${item.time}</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <span class="text-xs font-bold ${isPass ? 'text-green-600' : 'text-red-500'}">${item.status}</span>
                        <p class="text-[10px] text-slate-400">Score: ${item.score}</p>
                    </div>
                `;
                listContainer.appendChild(div);
            });
            lucide.createIcons();
        }

        // Admin: Save Master
        async function saveMasterData() {
            const btn = document.getElementById('btn-save-master');
            const linesStr = document.getElementById('edit-lines').value;
            const procsStr = document.getElementById('edit-processes').value;
            
            // Convert comma string to array
            const linesArr = linesStr.split(',').map(s => s.trim()).filter(s => s);
            const procsArr = procsStr.split(',').map(s => s.trim()).filter(s => s);

            if(!state.isMock) {
                btn.disabled = true;
                btn.innerText = "กำลังบันทึก...";
                try {
                    await fetch(GOOGLE_SCRIPT_URL, {
                        method: 'POST',
                        body: JSON.stringify({
                            action: 'updateMaster',
                            lines: linesArr,
                            processes: procsArr
                        })
                    });
                    alert("บันทึกข้อมูลเรียบร้อยแล้ว");
                } catch(e) {
                    alert("เกิดข้อผิดพลาด: " + e.message);
                } finally {
                    btn.disabled = false;
                    btn.innerText = "บันทึกข้อมูล Master";
                }
            } else {
                alert("(Offline Mode) บันทึกจำลองเรียบร้อย");
            }
        }

        function toggleProcessSelect() {
            const part = document.getElementById('new-q-part').value;
            const wrapper = document.getElementById('new-q-process-wrapper');
            const extraOpts = document.getElementById('extra-options');
            
            if(part == '1') {
                wrapper.classList.add('hidden');
                // Part 1 True/False -> Hide option 3 input or clear it
            } else {
                wrapper.classList.remove('hidden');
            }
        }

        // Admin: Save Question
        async function saveNewQuestion() {
            const part = document.getElementById('new-q-part').value;
            const process = document.getElementById('new-q-process').value;
            const text = document.getElementById('new-q-text').value;
            const opt1 = document.getElementById('opt-1').value;
            const opt2 = document.getElementById('opt-2').value;
            const opt3 = document.getElementById('opt-3').value;
            const correctIdx = document.getElementById('new-q-correct').value;

            if(!text || !opt1 || !opt2) {
                alert("กรุณากรอกข้อมูลคำถามและตัวเลือกอย่างน้อย 2 ข้อ");
                return;
            }

            // Map correct index to value
            const options = [opt1, opt2, opt3].filter(o => o);
            const correctVal = options[parseInt(correctIdx) - 1];

            if(!correctVal) {
                alert("กรุณาเลือกข้อที่ถูกต้องให้สัมพันธ์กับตัวเลือก");
                return;
            }

            const btn = document.getElementById('btn-save-question');
            if(!state.isMock) {
                btn.disabled = true;
                btn.innerText = "กำลังบันทึก...";
                try {
                    await fetch(GOOGLE_SCRIPT_URL, {
                        method: 'POST',
                        body: JSON.stringify({
                            action: 'addQuestion',
                            part: parseInt(part),
                            process: (part == '1') ? '' : process,
                            question: text,
                            opt1, opt2, opt3,
                            correct: correctVal
                        })
                    });
                    alert("เพิ่มข้อสอบเรียบร้อยแล้ว");
                    // Clear inputs
                    document.getElementById('new-q-text').value = '';
                    document.getElementById('opt-1').value = '';
                    document.getElementById('opt-2').value = '';
                    document.getElementById('opt-3').value = '';
                } catch(e) {
                    alert("เกิดข้อผิดพลาด: " + e.message);
                } finally {
                    btn.disabled = false;
                    btn.innerText = "บันทึกข้อสอบ";
                }
            } else {
                alert("(Offline Mode) บันทึกจำลองเรียบร้อย");
            }
        }

        // --- UTILS ---
        function normalize(str) { return str ? String(str).trim() : ''; }
        function getMockQuestions() {
            return [
                { id: 'm1', part: 1, text: 'Mock Q1', options: ['A','B'], correct: 'A' },
                { id: 'm2', part: 2, text: 'Mock Q2', options: ['X','Y','Z'], correct: 'X' },
                { id: 'm3', part: 3, text: 'Mock Q3', options: ['High','Low','Mid'], correct: 'High' }
            ];
        }

    </script>
</body>
</html>
